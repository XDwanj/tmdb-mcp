# Story 2.4: Enhanced Error Handling and Retry Logic

## Status
Ready for Review

## Story

**As a** developer,
**I want** to implement comprehensive error handling for all TMDB API calls,
**so that** users receive clear error messages and the service can gracefully handle rate limiting, network issues, and API errors.

## Acceptance Criteria

1. æ ‡å‡†åŒ–é”™è¯¯å“åº”ç»“æ„ï¼šåˆ›å»º `TMDBError` ç±»å‹
2. 401 Unauthorized å¤„ç†ï¼šç«‹å³è¿”å› "Invalid or missing TMDB API Key"ã€è®°å½• ERROR æ—¥å¿—ã€ä¸é‡è¯•
3. 404 Not Found å¤„ç†ï¼šè¿”å› "Resource not found"ã€è®°å½• INFO æ—¥å¿—ã€ä¸é‡è¯•
4. 429 Rate Limit Exceeded å¤„ç†ï¼šè§£æ `Retry-After` headerã€ç­‰å¾…åé‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰ã€è®°å½• WARN æ—¥å¿—
5. ç½‘ç»œè¶…æ—¶å¤„ç†ï¼šè¿”å› "Request timeout"ã€è®°å½• WARN æ—¥å¿—
6. å…¶ä»– HTTP é”™è¯¯ï¼ˆ500, 502, 503ï¼‰ï¼šè¿”å›é”™è¯¯æ¶ˆæ¯ã€è®°å½• ERROR æ—¥å¿—
7. JSON è§£æé”™è¯¯ï¼šè¿”å› "Failed to parse response"
8. MCP å·¥å…·å±‚é”™è¯¯å¤„ç†ï¼šè½¬æ¢ä¸º MCP é”™è¯¯å“åº”æ ¼å¼
9. æ—¥å¿—è®°å½•å¢å¼ºï¼šè®°å½• endpoint, parameters, response_time, error_type
10. ç¼–å†™å•å…ƒæµ‹è¯•ï¼šMock å„ç±»é”™è¯¯å“åº”ã€éªŒè¯é‡è¯•é€»è¾‘
11. ç¼–å†™é›†æˆæµ‹è¯•ï¼šä½¿ç”¨æ— æ•ˆ API Key è§¦å‘ 401ã€è¯·æ±‚ä¸å­˜åœ¨çš„ ID è§¦å‘ 404

## Tasks / Subtasks

- [ ] Task 1: é‡æ„å’Œå¢å¼º TMDBError ç±»å‹ (AC: 1)
  - [ ] æ£€æŸ¥ç°æœ‰ `internal/tmdb/error.go` ä¸­çš„ `TMDBError` ç»“æ„
  - [ ] æ·»åŠ é¢å¤–å­—æ®µï¼š`HTTPStatusCode int`, `ErrorType string`, `Retryable bool`
  - [ ] æ›´æ–° `Error()` æ–¹æ³•ä»¥åŒ…å«æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
  - [ ] å®šä¹‰é”™è¯¯ç±»å‹å¸¸é‡ï¼š`ErrorTypeAuth`, `ErrorTypeNotFound`, `ErrorTypeRateLimit`, `ErrorTypeServer`, `ErrorTypeNetwork`, `ErrorTypeParsing`

- [ ] Task 2: å¢å¼º handleError å‡½æ•°çš„é”™è¯¯åˆ†ç±» (AC: 2, 3, 5, 6, 7)
  - [ ] åœ¨ `internal/tmdb/error.go` å¢å¼º `handleError(resp *resty.Response) error` å‡½æ•°
  - [ ] 401å¤„ç†ï¼šè¿”å›æ¸…æ™°é”™è¯¯æ¶ˆæ¯ï¼Œè®¾ç½® `Retryable: false`ï¼Œè®°å½• ERROR æ—¥å¿—
  - [ ] 404å¤„ç†ï¼šè¿”å› "Resource not found"ï¼Œè®¾ç½® `Retryable: false`ï¼Œè®°å½• INFO æ—¥å¿—
  - [ ] ç½‘ç»œè¶…æ—¶å¤„ç†ï¼šæ£€æµ‹ context.DeadlineExceededï¼Œè¿”å› "Request timeout"
  - [ ] 500/502/503å¤„ç†ï¼šè¿”å› "TMDB API server error"ï¼Œè®¾ç½® `Retryable: true`ï¼ˆä¸ºé‡è¯•é€»è¾‘åšå‡†å¤‡ï¼‰
  - [ ] JSONè§£æé”™è¯¯å¤„ç†ï¼šè¿”å› "Failed to parse TMDB API response"
  - [ ] æœªçŸ¥é”™è¯¯å¤„ç†ï¼šè¿”å›é€šç”¨é”™è¯¯æ¶ˆæ¯

- [ ] Task 3: é…ç½® Resty Client çš„é‡è¯•æœºåˆ¶ (AC: 4)
  - [ ] åœ¨ `internal/tmdb/client.go` çš„ `NewClient()` ä¸­é…ç½® Resty é‡è¯•
  - [ ] ä½¿ç”¨ `SetRetryCount(3)` è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°
  - [ ] ä½¿ç”¨ `SetRetryWaitTime(1 * time.Second)` è®¾ç½®åˆå§‹ç­‰å¾…æ—¶é—´
  - [ ] ä½¿ç”¨ `SetRetryMaxWaitTime(10 * time.Second)` è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´
  - [ ] ä½¿ç”¨ `AddRetryConditions()` æ·»åŠ è‡ªå®šä¹‰é‡è¯•æ¡ä»¶ï¼šä»…å¯¹ 429/500/502/503 é‡è¯•
  - [ ] ä½¿ç”¨ `AddRetryHooks()` æ·»åŠ é‡è¯•é’©å­ï¼šè®°å½• WARN æ—¥å¿—
  - [ ] ä½¿ç”¨ `SetRetryStrategy()` å®ç°æŒ‡æ•°é€€é¿ï¼ˆ500/502/503ï¼‰å’Œ Retry-After è§£æï¼ˆ429ï¼‰
  - [ ] æ³¨æ„ï¼šResty è‡ªåŠ¨å°Šé‡ Retry-After headerï¼Œæ— éœ€æ‰‹åŠ¨è§£æ

- [ ] Task 4: éªŒè¯é‡è¯•æœºåˆ¶ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ (AC: 4)
  - [ ] éªŒè¯ 401/404 é”™è¯¯ä¸ä¼šè§¦å‘é‡è¯•ï¼ˆé€šè¿‡ RetryConditions æ’é™¤ï¼‰
  - [ ] éªŒè¯é€Ÿç‡é™åˆ¶å™¨ `rateLimiter.Wait(ctx)` åœ¨æ¯æ¬¡é‡è¯•å‰ä¾ç„¶ç”Ÿæ•ˆ
  - [ ] ç¡®ä¿ Context å–æ¶ˆèƒ½ç«‹å³ç»ˆæ­¢é‡è¯•æµç¨‹
  - [ ] æµ‹è¯•æ‰€æœ‰ç°æœ‰ API æ–¹æ³•ï¼ˆsearch/details/discoverï¼‰çš„é‡è¯•è¡Œä¸ºä¸€è‡´

- [ ] Task 5: å¢å¼ºæ—¥å¿—è®°å½• (AC: 9)
  - [ ] åœ¨æ‰€æœ‰ TMDB Client æ–¹æ³•ä¸­æ·»åŠ ç»“æ„åŒ–æ—¥å¿—å­—æ®µ
  - [ ] è¯·æ±‚å¼€å§‹æ—¥å¿—ï¼ˆDEBUGï¼‰ï¼š`zap.String("endpoint", endpoint)`, `zap.Any("params", params)`
  - [ ] è¯·æ±‚æˆåŠŸæ—¥å¿—ï¼ˆINFOï¼‰ï¼š`zap.Duration("response_time", duration)`, `zap.Int("status_code", statusCode)`
  - [ ] è¯·æ±‚å¤±è´¥æ—¥å¿—ï¼ˆERRORï¼‰ï¼š`zap.String("error_type", errType)`, `zap.Int("status_code", statusCode)`, `zap.Duration("response_time", duration)`
  - [ ] é‡è¯•æ—¥å¿—ï¼ˆWARNï¼‰ï¼š`zap.Int("attempt", attemptNum)`, `zap.String("reason", reason)`, `zap.Duration("retry_after", retryAfter)`
  - [ ] ç¡®ä¿ä¸è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Key åº”è¢«é®ç›–ï¼‰

- [ ] Task 6: MCP å·¥å…·å±‚é”™è¯¯è½¬æ¢ (AC: 8)
  - [ ] åœ¨æ‰€æœ‰ MCP å·¥å…·ï¼ˆ`internal/tools/*.go`ï¼‰ä¸­ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
  - [ ] å°† TMDB Client è¿”å›çš„é”™è¯¯è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„ MCP é”™è¯¯æ¶ˆæ¯
  - [ ] 401é”™è¯¯ â†’ "Authentication failed. Please check your TMDB API Key configuration."
  - [ ] 404é”™è¯¯ â†’ "The requested [movie/TV show/person] was not found."
  - [ ] 429é”™è¯¯ â†’ "Rate limit exceeded. Please try again later."
  - [ ] è¶…æ—¶é”™è¯¯ â†’ "Request timed out. Please try again."
  - [ ] æœåŠ¡å™¨é”™è¯¯ â†’ "TMDB service is temporarily unavailable. Please try again later."
  - [ ] è®°å½•é”™è¯¯è¯¦æƒ…åˆ°æ—¥å¿—ï¼Œä½†è¿”å›ç»™ç”¨æˆ·ç®€åŒ–æ¶ˆæ¯

- [ ] Task 7: ç¼–å†™å•å…ƒæµ‹è¯• (AC: 10)
  - [ ] åœ¨ `internal/tmdb/error_test.go` æ·»åŠ é”™è¯¯å¤„ç†æµ‹è¯•
  - [ ] æµ‹è¯• TMDBError ç»“æ„ï¼šéªŒè¯å­—æ®µæ­£ç¡®å¡«å……ï¼ŒError() æ–¹æ³•æ ¼å¼
  - [ ] æµ‹è¯• handleError å‡½æ•°ï¼š401/404/429/500/502/503/è¶…æ—¶/JSONè§£æé”™è¯¯åœºæ™¯
  - [ ] åœ¨ `internal/tmdb/client_test.go` æ·»åŠ  Resty é‡è¯•é…ç½®æµ‹è¯•
  - [ ] æµ‹è¯•é‡è¯•é…ç½®ï¼šéªŒè¯ RetryCount=3, RetryWaitTime=1s, RetryMaxWaitTime=10s
  - [ ] æµ‹è¯•é‡è¯•æ¡ä»¶ï¼šMock 429/500/502/503 å“åº”ï¼ŒéªŒè¯è§¦å‘é‡è¯•
  - [ ] æµ‹è¯•ä¸é‡è¯•æ¡ä»¶ï¼šMock 401/404 å“åº”ï¼ŒéªŒè¯ä¸è§¦å‘é‡è¯•
  - [ ] æµ‹è¯•é‡è¯•é’©å­ï¼šéªŒè¯ WARN æ—¥å¿—è¢«æ­£ç¡®è®°å½•
  - [ ] æµ‹è¯• Context å–æ¶ˆï¼šéªŒè¯é‡è¯•è¿‡ç¨‹ä¸­ context å–æ¶ˆèƒ½ç«‹å³ç»ˆæ­¢
  - [ ] ä½¿ç”¨ `httptest.NewServer` Mock TMDB API å“åº”

- [ ] Task 8: ç¼–å†™é›†æˆæµ‹è¯• (AC: 11)
  - [ ] åœ¨ `cmd/tmdb-mcp/integration_test.go` æ·»åŠ é”™è¯¯å¤„ç†é›†æˆæµ‹è¯•
  - [ ] æµ‹è¯• 401 åœºæ™¯ï¼šä½¿ç”¨æ— æ•ˆ API Key è°ƒç”¨ä»»æ„å·¥å…·ï¼ŒéªŒè¯è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
  - [ ] æµ‹è¯• 404 åœºæ™¯ï¼šè¯·æ±‚ä¸å­˜åœ¨çš„ IDï¼ˆ99999999ï¼‰ï¼ŒéªŒè¯å·¥å…·è¿”å› "not found" æ¶ˆæ¯
  - [ ] æµ‹è¯•é‡è¯•åœºæ™¯ï¼ˆå¯é€‰ï¼Œä½¿ç”¨ Mock TMDB APIï¼‰ï¼šæ¨¡æ‹Ÿ 429 å“åº”ï¼ŒéªŒè¯è‡ªåŠ¨é‡è¯•
  - [ ] æµ‹è¯•è¶…æ—¶åœºæ™¯ï¼šä½¿ç”¨çŸ­è¶…æ—¶ Contextï¼ŒéªŒè¯è¶…æ—¶é”™è¯¯å¤„ç†
  - [ ] éªŒè¯é”™è¯¯æ—¥å¿—è®°å½•ï¼šæ£€æŸ¥æ—¥å¿—åŒ…å«å¿…éœ€çš„ç»“æ„åŒ–å­—æ®µ

- [ ] Task 9: æ›´æ–°ç°æœ‰æµ‹è¯•ä»¥é€‚åº”æ–°çš„é”™è¯¯å¤„ç† (AC: 10, 11)
  - [ ] æ£€æŸ¥å¹¶æ›´æ–° `internal/tmdb/*_test.go` ä¸­çš„é”™è¯¯æµ‹è¯•
  - [ ] ç¡®ä¿ç°æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡ï¼ˆ404/401 å¤„ç†é€»è¾‘æœªæ”¹å˜ï¼‰
  - [ ] æ·»åŠ å¯¹æ–°é”™è¯¯å­—æ®µçš„éªŒè¯ï¼ˆErrorType, Retryableï¼‰
  - [ ] æ›´æ–°é›†æˆæµ‹è¯•ä»¥éªŒè¯é‡è¯•é€»è¾‘ä¸å½±å“æ­£å¸¸æµç¨‹

## Dev Notes

### å‰ä¸€ä¸ªæ•…äº‹çš„é‡è¦æ´å¯Ÿ

ä» Story 2.3 (Implement discover_tv Tool) å’Œä¹‹å‰æ•…äº‹çš„å®Œæˆè®°å½•ä¸­è·å–çš„å…³é”®ä¿¡æ¯ï¼š

**ç°æœ‰é”™è¯¯å¤„ç†åŸºç¡€**ï¼š
1. âœ… `internal/tmdb/error.go` å·²å­˜åœ¨åŸºç¡€çš„ `TMDBError` ç±»å‹å’Œ `handleError()` å‡½æ•°
2. âœ… 401/404/429 çš„åŸºæœ¬é”™è¯¯è¯†åˆ«å·²å®ç°
3. âœ… 404 åœ¨ search.go, details.go, discover.go ä¸­è¿”å›ç©ºç»“æœï¼ˆ`(nil, nil)`ï¼‰
4. âœ… 401 åœ¨ client_test.go ä¸­æœ‰æµ‹è¯•è¦†ç›–
5. âš ï¸ **ç¼ºå°‘é‡è¯•é€»è¾‘**ï¼š429 é”™è¯¯è™½ç„¶è§£æ Retry-Afterï¼Œä½†æœªå®ç°è‡ªåŠ¨é‡è¯•
6. âš ï¸ **ç¼ºå°‘ 500/502/503 ä¸“é—¨å¤„ç†**ï¼šå½“å‰ä»…è¿”å›é€šç”¨é”™è¯¯
7. âš ï¸ **æ—¥å¿—è®°å½•ä¸å¤Ÿè¯¦ç»†**ï¼šç¼ºå°‘ endpoint, parameters, error_type ç­‰ç»“æ„åŒ–å­—æ®µ

**é‡è¦è®¾è®¡å†³ç­–ï¼ˆå¿…é¡»ä¿æŒä¸€è‡´ï¼‰**ï¼š
- 404 å¤„ç†ï¼šTMDB Client å±‚è¿”å› `(nil, nil)`,Tools å±‚æ£€æŸ¥å¹¶è¿”å›å‹å¥½é”™è¯¯
- é”™è¯¯åŒ…è£…ï¼šä½¿ç”¨ `fmt.Errorf("context: %w", err)` ä¿ç•™é”™è¯¯é“¾
- æ—¥å¿—çº§åˆ«ï¼š401 â†’ ERROR, 404 â†’ INFO, 429 â†’ WARN, 500+ â†’ ERROR
- é€Ÿç‡é™åˆ¶å™¨ï¼š`rateLimiter.Wait(ctx)` åœ¨ API è°ƒç”¨å‰ï¼Œé‡è¯•é€»è¾‘åº”åœ¨æ­¤ä¹‹å

[Source: docs/stories/2.3.implement-discover-tv-tool.md#Dev Agent Record]
[Source: docs/stories/2.1.implement-get-details-tool.md#é”™è¯¯å¤„ç†ç­–ç•¥]
[Source: docs/stories/1.3.tmdb-api-client-foundation.md#é”™è¯¯å¤„ç†ç­–ç•¥]

### é¡¹ç›®æºç æ ‘ç»“æ„

**ä¿®æ”¹æ–‡ä»¶ä½ç½®**ï¼š

```
internal/tmdb/
â”œâ”€â”€ client.go             # ä¿®æ”¹ï¼šé…ç½® Resty é‡è¯•æœºåˆ¶
â”œâ”€â”€ error.go              # ä¿®æ”¹ï¼šå¢å¼º TMDBError å’Œ handleError
â”œâ”€â”€ error_test.go         # ä¿®æ”¹ï¼šæ·»åŠ æ›´å¤šé”™è¯¯æµ‹è¯•
â””â”€â”€ client_test.go        # ä¿®æ”¹ï¼šæ·»åŠ é‡è¯•é…ç½®æµ‹è¯•
```

**ä¿®æ”¹ MCP å·¥å…·æ–‡ä»¶**ï¼ˆé”™è¯¯æ¶ˆæ¯è½¬æ¢ï¼‰ï¼š
```
internal/tools/
â”œâ”€â”€ search.go             # ä¿®æ”¹ï¼šå¢å¼ºé”™è¯¯æ¶ˆæ¯
â”œâ”€â”€ get_details.go        # ä¿®æ”¹ï¼šå¢å¼ºé”™è¯¯æ¶ˆæ¯
â”œâ”€â”€ discover_movies.go    # ä¿®æ”¹ï¼šå¢å¼ºé”™è¯¯æ¶ˆæ¯
â””â”€â”€ discover_tv.go        # ä¿®æ”¹ï¼šå¢å¼ºé”™è¯¯æ¶ˆæ¯
```

[Source: docs/architecture/source-tree.md]

### æŠ€æœ¯æ ˆå’Œä¾èµ–

**æ ¸å¿ƒä¾èµ–**ï¼ˆå·²é›†æˆï¼‰ï¼š
- `github.com/go-resty/resty/v2` - HTTP Clientï¼Œ**å†…ç½®é‡è¯•æœºåˆ¶**ï¼ˆæ”¯æŒè‡ªå®šä¹‰æ¡ä»¶ã€é’©å­ã€ç­–ç•¥ï¼‰
- `go.uber.org/zap` - ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ
- `context` (æ ‡å‡†åº“) - æ”¯æŒå–æ¶ˆå’Œè¶…æ—¶æ§åˆ¶

**æµ‹è¯•ä¾èµ–**ï¼ˆå·²é›†æˆï¼‰ï¼š
- `testing` (æ ‡å‡†åº“) - Go åŸç”Ÿæµ‹è¯•æ¡†æ¶
- `github.com/stretchr/testify/assert` - æ–­è¨€åº“
- `net/http/httptest` (æ ‡å‡†åº“) - Mock HTTP Server

[Source: docs/architecture/tech-stack.md]

### é”™è¯¯å¤„ç†ç­–ç•¥è¯¦ç»†è§„èŒƒ

#### TMDBError å¢å¼ºç»“æ„

```go
type TMDBError struct {
    StatusCode     int    `json:"status_code"`     // TMDB API è¿”å›çš„çŠ¶æ€ç 
    StatusMessage  string `json:"status_message"`  // TMDB API è¿”å›çš„é”™è¯¯æ¶ˆæ¯
    HTTPStatusCode int    `json:"-"`               // HTTP çŠ¶æ€ç ï¼ˆå¯èƒ½ä¸åŒäº TMDB çŠ¶æ€ç ï¼‰
    ErrorType      string `json:"-"`               // é”™è¯¯ç±»å‹åˆ†ç±»
    Retryable      bool   `json:"-"`               // æ˜¯å¦å¯é‡è¯•
}

// é”™è¯¯ç±»å‹å¸¸é‡
const (
    ErrorTypeAuth        = "authentication"
    ErrorTypeNotFound    = "not_found"
    ErrorTypeRateLimit   = "rate_limit"
    ErrorTypeServer      = "server_error"
    ErrorTypeNetwork     = "network_error"
    ErrorTypeParsing     = "parsing_error"
    ErrorTypeUnknown     = "unknown"
)
```

[Source: docs/architecture/data-models.md#Error Model]

#### é‡è¯•ç­–ç•¥è¯¦ç»†å®šä¹‰

**ä¸é‡è¯•çš„é”™è¯¯**ï¼š
- 401 Unauthorized (è®¤è¯å¤±è´¥ï¼Œé‡è¯•æ— æ„ä¹‰)
- 404 Not Found (èµ„æºä¸å­˜åœ¨ï¼Œé‡è¯•æ— æ„ä¹‰)
- 400 Bad Request (å‚æ•°é”™è¯¯ï¼Œé‡è¯•æ— æ„ä¹‰)
- Network Timeout (å·²ç»è¶…æ—¶ï¼Œé‡è¯•åº”ç”±è°ƒç”¨æ–¹å†³å®š)

**éœ€è¦é‡è¯•çš„é”™è¯¯**ï¼š
- 429 Rate Limit Exceeded (ç­‰å¾… Retry-After ç§’åé‡è¯•)
- 500 Internal Server Error (æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s)
- 502 Bad Gateway (æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s)
- 503 Service Unavailable (æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s)

#### ä½¿ç”¨ Resty å†…ç½®é‡è¯•æœºåˆ¶

Resty v2/v3 æä¾›äº†å®Œæ•´çš„é‡è¯•æœºåˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨å®ç°ã€‚å…³é”® APIï¼š

```go
// åœ¨ NewClient() ä¸­é…ç½® Resty é‡è¯•
httpClient := resty.New().
    SetBaseURL("https://api.themoviedb.org/3").
    SetTimeout(10 * time.Second).

    // é‡è¯•åŸºç¡€é…ç½®
    SetRetryCount(3).
    SetRetryWaitTime(1 * time.Second).
    SetRetryMaxWaitTime(10 * time.Second).

    // è‡ªå®šä¹‰é‡è¯•æ¡ä»¶ï¼šä»…å¯¹ 429/500/502/503 é‡è¯•
    AddRetryConditions(func(res *resty.Response, err error) bool {
        // ç½‘ç»œé”™è¯¯æˆ– nil responseï¼Œç”±é»˜è®¤æ¡ä»¶å¤„ç†
        if err != nil || res == nil {
            return false
        }

        // ä»…å¯¹ç‰¹å®šçŠ¶æ€ç é‡è¯•
        statusCode := res.StatusCode()
        return statusCode == 429 || statusCode == 500 || statusCode == 502 || statusCode == 503
    }).

    // æ·»åŠ é‡è¯•é’©å­ï¼šè®°å½•é‡è¯•æ—¥å¿—
    AddRetryHooks(func(res *resty.Response, err error) {
        statusCode := 0
        if res != nil {
            statusCode = res.StatusCode()
        }

        logger.Warn("Retrying TMDB API request",
            zap.Int("status_code", statusCode),
            zap.Error(err),
        )
    }).

    // è‡ªå®šä¹‰é‡è¯•ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿
    SetRetryStrategy(func(res *resty.Response, err error) (time.Duration, error) {
        // 429 é”™è¯¯ï¼šResty è‡ªåŠ¨å°Šé‡ Retry-After header
        // æ— éœ€æ‰‹åŠ¨è§£æï¼ŒResty ä¼šä¼˜å…ˆä½¿ç”¨ Retry-After å€¼
        if res != nil && res.StatusCode() == 429 {
            // Resty è‡ªåŠ¨å¤„ç†ï¼Œè¿™é‡Œè¿”å›é»˜è®¤ç­‰å¾…æ—¶é—´å³å¯
            return 0, nil // è¿”å› 0 è¡¨ç¤ºä½¿ç”¨ Resty å†…ç½®çš„ Retry-After é€»è¾‘
        }

        // 500/502/503 é”™è¯¯ï¼šæŒ‡æ•°é€€é¿
        if res != nil && (res.StatusCode() == 500 || res.StatusCode() == 502 || res.StatusCode() == 503) {
            // Resty ä¼šæ ¹æ® attempt è‡ªåŠ¨è®¡ç®—ç­‰å¾…æ—¶é—´
            // æˆ‘ä»¬å¯ä»¥è¿”å›è‡ªå®šä¹‰çš„æŒ‡æ•°é€€é¿æ—¶é—´
            return 0, nil // è¿”å› 0 ä½¿ç”¨é»˜è®¤çš„é€€é¿ç­–ç•¥
        }

        return 0, nil
    })
```

**å…³é”®ç‰¹æ€§**ï¼ˆResty è‡ªåŠ¨å¤„ç†ï¼‰ï¼š
1. âœ… **è‡ªåŠ¨å°Šé‡ Retry-After header**ï¼ˆ429 é”™è¯¯ï¼‰- æ— éœ€æ‰‹åŠ¨è§£æ
2. âœ… **é»˜è®¤åªå¯¹å¹‚ç­‰æ–¹æ³•é‡è¯•**ï¼ˆGET/HEAD/PUT/DELETE/OPTIONS/TRACEï¼‰
3. âœ… **æ”¯æŒ Context å–æ¶ˆ**ï¼ˆè‡ªåŠ¨æ£€æŸ¥ `ctx.Done()`ï¼‰
4. âœ… **æ”¯æŒ io.ReadSeeker è‡ªåŠ¨é‡ç½®**ï¼ˆè¯·æ±‚ä½“å¯é‡å¤è¯»å–ï¼‰
5. âœ… **RetryConditions ä¸²è”æ‰§è¡Œ**ï¼ˆé»˜è®¤æ¡ä»¶ + è‡ªå®šä¹‰æ¡ä»¶ï¼‰

**é‡è¦æ³¨æ„äº‹é¡¹**ï¼š
- Resty v3 é»˜è®¤å¯ç”¨äº† `DefaultRetryConditions`ï¼Œä¼šè‡ªåŠ¨é‡è¯•ç½‘ç»œé”™è¯¯
- ä½¿ç”¨ `AddRetryConditions()` æ·»åŠ è‡ªå®šä¹‰æ¡ä»¶ï¼Œ**ä¸ä¼š**è¦†ç›–é»˜è®¤æ¡ä»¶
- å¦‚æœéœ€è¦å®Œå…¨è‡ªå®šä¹‰ï¼Œä½¿ç”¨ `SetRetryDefaultConditions()` æˆ– `DisableRetryDefaultConditions()`
- RetryAfter header å¤„ç†æ˜¯å†…ç½®çš„ï¼Œ`SetRetryStrategy` è¿”å› 0 æ—¶ä½¿ç”¨ Resty å†…ç½®é€»è¾‘

[Source: go-resty/docs - Retry Mechanism]
[Source: go-resty/docs - Upgrading to v3]

#### æ—¥å¿—è®°å½•å¢å¼ºè§„èŒƒ

**è¯·æ±‚å¼€å§‹æ—¥å¿—ï¼ˆDEBUG çº§åˆ«ï¼‰**ï¼š
```go
c.logger.Debug("Starting TMDB API request",
    zap.String("endpoint", endpoint),
    zap.Any("params", params),  // æ³¨æ„ï¼šä¸è¦è®°å½• api_key
)
```

**è¯·æ±‚æˆåŠŸæ—¥å¿—ï¼ˆINFO çº§åˆ«ï¼‰**ï¼š
```go
c.logger.Info("TMDB API request succeeded",
    zap.String("endpoint", endpoint),
    zap.Int("status_code", resp.StatusCode()),
    zap.Duration("response_time", duration),
    zap.Int("result_count", len(results)),
)
```

**è¯·æ±‚å¤±è´¥æ—¥å¿—ï¼ˆERROR/WARN çº§åˆ«ï¼‰**ï¼š
```go
c.logger.Error("TMDB API request failed",
    zap.String("endpoint", endpoint),
    zap.String("error_type", errorType),
    zap.Int("http_status_code", resp.StatusCode()),
    zap.Duration("response_time", duration),
    zap.Error(err),
)
```

**é‡è¯•æ—¥å¿—ï¼ˆWARN çº§åˆ«ï¼‰**ï¼š
```go
c.logger.Warn("Retrying TMDB API request",
    zap.String("endpoint", endpoint),
    zap.Int("attempt", attemptNum),
    zap.Int("max_retries", maxRetries),
    zap.String("reason", "rate_limit" or "server_error"),
    zap.Duration("retry_after", waitDuration),
)
```

**æ•æ„Ÿä¿¡æ¯é®ç›–**ï¼š
- âŒ **ç¦æ­¢è®°å½•**ï¼šå®Œæ•´ API Key
- âœ… **å…è®¸è®°å½•**ï¼šAPI Key å‰ 8 ä¸ªå­—ç¬¦ï¼ˆå¦‚æœå¿…é¡»è®°å½•ï¼‰
- âŒ **ç¦æ­¢è®°å½•**ï¼šSSE Token æ˜æ–‡
- âœ… **å…è®¸è®°å½•**ï¼šè¯·æ±‚ URLï¼ˆä¸å« api_key å‚æ•°ï¼‰

[Source: docs/architecture/error-handling-strategy.md#Logging Standards]

### MCP å·¥å…·å±‚é”™è¯¯æ¶ˆæ¯æ˜ å°„

**åŸåˆ™**ï¼šTMDB Client è¿”å›æŠ€æœ¯æ€§é”™è¯¯ï¼ŒMCP Tools è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½æ¶ˆæ¯ã€‚

**é”™è¯¯æ¶ˆæ¯æ˜ å°„è¡¨**ï¼š

| TMDB Client é”™è¯¯ç±»å‹ | MCP Tool è¿”å›æ¶ˆæ¯ï¼ˆè‹±æ–‡ï¼‰ | æ—¥å¿—çº§åˆ« |
|---------------------|-------------------------|---------|
| 401 Unauthorized | "Authentication failed. Please check your TMDB API Key configuration." | ERROR |
| 404 Not Found | "The requested [movie/TV show/person] was not found." | INFO |
| 429 Rate Limit | "Rate limit exceeded. The service will automatically retry shortly." | WARN |
| Timeout | "Request timed out. Please try again or check your network connection." | WARN |
| 500/502/503 | "TMDB service is temporarily unavailable. Please try again later." | ERROR |
| JSON Parsing Error | "Failed to process TMDB API response. Please try again." | ERROR |

**å®ç°æ¨¡å¼ï¼ˆåœ¨ Tools å±‚ï¼‰**ï¼š
```go
result, err := t.tmdbClient.Search(ctx, params)
if err != nil {
    var tmdbErr *tmdb.TMDBError
    if errors.As(err, &tmdbErr) {
        switch tmdbErr.ErrorType {
        case tmdb.ErrorTypeAuth:
            return nil, nil, fmt.Errorf("authentication failed. Please check your TMDB API Key configuration")
        case tmdb.ErrorTypeNotFound:
            return nil, nil, fmt.Errorf("the requested content was not found")
        case tmdb.ErrorTypeRateLimit:
            return nil, nil, fmt.Errorf("rate limit exceeded. The service will automatically retry shortly")
        // ... å…¶ä»–é”™è¯¯ç±»å‹
        }
    }

    // é€šç”¨é”™è¯¯æ¶ˆæ¯
    return nil, nil, fmt.Errorf("failed to search TMDB: %w", err)
}
```

[Source: docs/architecture/error-handling-strategy.md#Error Translation]

### ç¼–ç æ ‡å‡†

**Critical Rules for this Story**ï¼š
- **æ—¥å¿—è§„åˆ™**: å§‹ç»ˆä½¿ç”¨ Zap loggerï¼ˆ`logger.Info()`, `logger.Error()` ç­‰ï¼‰ï¼Œä¸ä½¿ç”¨ `fmt.Println`
- **é”™è¯¯å¤„ç†**: ä½¿ç”¨ `fmt.Errorf("context: %w", err)` åŒ…è£…é”™è¯¯ï¼Œä¿ç•™åŸå§‹é”™è¯¯é“¾
- **é”™è¯¯ç±»å‹åˆ¤æ–­**: ä½¿ç”¨ `errors.As()` åˆ¤æ–­é”™è¯¯ç±»å‹ï¼Œè€Œéå­—ç¬¦ä¸²åŒ¹é…
- **Context ä¼ é€’**: æ‰€æœ‰éœ€è¦å–æ¶ˆæˆ–è¶…æ—¶æ§åˆ¶çš„å‡½æ•°å¿…é¡»æ¥å— `context.Context` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
- **é‡è¯•ç­‰å¾…**: ä½¿ç”¨ `time.After()` é…åˆ `select` æ”¯æŒ context å–æ¶ˆï¼Œè€Œéè£¸ `time.Sleep()`
- **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**: æ°¸è¿œä¸åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´ API Key æˆ– Token
- **ä¾èµ–æ³¨å…¥**: ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œä¸ä½¿ç”¨å…¨å±€å˜é‡

**é”™è¯¯åˆ¤æ–­æœ€ä½³å®è·µ**ï¼š
```go
// âœ… Good - ä½¿ç”¨ errors.As
var tmdbErr *TMDBError
if errors.As(err, &tmdbErr) {
    // å®‰å…¨è®¿é—® tmdbErr.ErrorType
}

// âŒ Bad - å­—ç¬¦ä¸²åŒ¹é…
if strings.Contains(err.Error(), "401") {
    // è„†å¼±ï¼Œé”™è¯¯æ¶ˆæ¯æ ¼å¼å˜åŒ–ä¼šå¯¼è‡´å¤±è´¥
}
```

**Context å–æ¶ˆæ”¯æŒ**ï¼š
```go
// âœ… Good - æ”¯æŒ context å–æ¶ˆ
select {
case <-time.After(retryAfter):
    continue
case <-ctx.Done():
    return nil, ctx.Err()
}

// âŒ Bad - å¿½ç•¥ context
time.Sleep(retryAfter)
```

[Source: docs/architecture/coding-standards.md#Critical Rules]

### Testing

#### æµ‹è¯•æ–‡ä»¶ä½ç½®
- **é”™è¯¯å¤„ç†å•å…ƒæµ‹è¯•**: `internal/tmdb/error_test.go`ï¼ˆå·²å­˜åœ¨ï¼Œéœ€å¢å¼ºï¼‰
- **é‡è¯•é…ç½®å•å…ƒæµ‹è¯•**: `internal/tmdb/client_test.go`ï¼ˆå·²å­˜åœ¨ï¼Œæ·»åŠ é‡è¯•æµ‹è¯•ï¼‰
- **é›†æˆæµ‹è¯•**: `cmd/tmdb-mcp/integration_test.go`ï¼ˆæ·»åŠ æ–°æµ‹è¯•å‡½æ•°ï¼‰

#### æµ‹è¯•æ ‡å‡†
- ä½¿ç”¨ `testing` æ ‡å‡†åº“å’Œ `testify/assert` è¿›è¡Œæ–­è¨€
- æµ‹è¯•å‡½æ•°å‘½åï¼š`TestClient_RetryConfiguration`, `TestClient_RetryConditions`
- ä½¿ç”¨ Table-driven tests å¤„ç†å¤šåœºæ™¯
- ä½¿ç”¨ `httptest.NewServer` Mock TMDB API å“åº”

#### ç‰¹å®šæµ‹è¯•è¦æ±‚

**é”™è¯¯å¤„ç†å•å…ƒæµ‹è¯•**ï¼ˆ`internal/tmdb/error_test.go`ï¼‰ï¼š
1. **å¢å¼ºç°æœ‰æµ‹è¯•**ï¼š
   - æµ‹è¯•æ–°å¢çš„ `ErrorType` å­—æ®µæ­£ç¡®å¡«å……
   - æµ‹è¯•æ–°å¢çš„ `Retryable` å­—æ®µæ­£ç¡®è®¾ç½®
   - æµ‹è¯•æ‰€æœ‰é”™è¯¯ç ï¼ˆ401/404/429/500/502/503/è¶…æ—¶/JSONè§£æé”™è¯¯ï¼‰

2. **Mock Server ç¤ºä¾‹**ï¼š
```go
mockServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    // æ¨¡æ‹Ÿ 500 Internal Server Error
    w.WriteHeader(500)
    json.NewEncoder(w).Encode(map[string]interface{}{
        "status_code":    25,
        "status_message": "Internal error",
    })
}))
defer mockServer.Close()
```

**é‡è¯•é…ç½®å•å…ƒæµ‹è¯•**ï¼ˆ`internal/tmdb/client_test.go`ï¼‰ï¼š
1. **é…ç½®éªŒè¯**ï¼š
   - æµ‹è¯• Resty Client çš„é‡è¯•é…ç½®ï¼šRetryCount=3, RetryWaitTime=1s, RetryMaxWaitTime=10s
   - éªŒè¯é‡è¯•æ¡ä»¶å·²æ­£ç¡®æ³¨å†Œ
   - éªŒè¯é‡è¯•é’©å­å·²æ­£ç¡®æ³¨å†Œ

2. **é‡è¯•æ¡ä»¶æµ‹è¯•**ï¼š
   - Mock 429 å“åº”ï¼ˆå¸¦ Retry-After headerï¼‰ï¼šéªŒè¯è§¦å‘é‡è¯•
   - Mock 500/502/503 å“åº”ï¼šéªŒè¯è§¦å‘é‡è¯•
   - Mock 401/404 å“åº”ï¼šéªŒè¯**ä¸**è§¦å‘é‡è¯•
   - ä½¿ç”¨è®¡æ•°å™¨éªŒè¯å®é™…è¯·æ±‚æ¬¡æ•°

3. **é‡è¯•é’©å­æµ‹è¯•**ï¼š
   - Mock 429 å“åº”è§¦å‘é‡è¯•
   - éªŒè¯é‡è¯•é’©å­è¢«è°ƒç”¨ï¼ˆé€šè¿‡ mock logger æˆ–è®¡æ•°å™¨ï¼‰
   - éªŒè¯æ—¥å¿—åŒ…å« `status_code` å­—æ®µ

4. **Context å–æ¶ˆæµ‹è¯•**ï¼š
   - Mock æ…¢é€ŸæœåŠ¡å™¨ï¼ˆå»¶è¿Ÿå“åº”ï¼‰
   - åœ¨ç¬¬ä¸€æ¬¡é‡è¯•ç­‰å¾…æœŸé—´å–æ¶ˆ context
   - éªŒè¯ç«‹å³è¿”å› `context.Canceled` é”™è¯¯

5. **æµ‹è¯•ç¤ºä¾‹**ï¼š
```go
func TestClient_RetryConditions(t *testing.T) {
    requestCount := 0
    mockServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        requestCount++
        if requestCount < 3 {
            // å‰ 2 æ¬¡è¿”å› 500ï¼Œè§¦å‘é‡è¯•
            w.WriteHeader(500)
            return
        }
        // ç¬¬ 3 æ¬¡è¿”å› 200
        w.WriteHeader(200)
        json.NewEncoder(w).Encode(map[string]interface{}{
            "results": []interface{}{},
        })
    }))
    defer mockServer.Close()

    // åˆ›å»ºé…ç½®äº†é‡è¯•çš„ Clientï¼ˆæŒ‡å‘ mock serverï¼‰
    config := tmdb.Config{BaseURL: mockServer.URL}
    client := tmdb.NewClient(config, logger)

    // æ‰§è¡Œè¯·æ±‚
    _, err := client.Search(context.Background(), "test", 1)

    // éªŒè¯
    assert.NoError(t, err)
    assert.Equal(t, 3, requestCount) // 1 æ¬¡åˆå§‹ + 2 æ¬¡é‡è¯•
}
```

**é›†æˆæµ‹è¯•**ï¼ˆ`cmd/tmdb-mcp/integration_test.go`ï¼‰ï¼š
1. **401 åœºæ™¯**ï¼ˆä½¿ç”¨ Mock TMDB APIï¼‰ï¼š
   - åˆ›å»ºä½¿ç”¨æ— æ•ˆ API Key çš„ TMDB Client
   - è°ƒç”¨ä»»æ„ MCP å·¥å…·ï¼ˆsearch/get_detailsï¼‰
   - éªŒè¯è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
   - éªŒè¯æ—¥å¿—åŒ…å« ERROR çº§åˆ«å’Œ `error_type: authentication`

2. **404 åœºæ™¯**ï¼ˆä½¿ç”¨çœŸå®æˆ– Mock TMDB APIï¼‰ï¼š
   - è¯·æ±‚ä¸å­˜åœ¨çš„ IDï¼ˆ99999999ï¼‰
   - éªŒè¯å·¥å…·è¿”å› "not found" æ¶ˆæ¯
   - éªŒè¯æ—¥å¿—åŒ…å« INFO çº§åˆ«

3. **é‡è¯•åœºæ™¯**ï¼ˆä½¿ç”¨ Mock TMDB APIï¼‰ï¼š
   - Mock server ç¬¬ 1ã€2 æ¬¡è¿”å› 500ï¼Œç¬¬ 3 æ¬¡è¿”å› 200
   - éªŒè¯è¯·æ±‚æœ€ç»ˆæˆåŠŸ
   - éªŒè¯é€šè¿‡é‡è¯•é’©å­è®°å½•çš„æ—¥å¿—åŒ…å«é‡è¯•ä¿¡æ¯
   - éªŒè¯æ€»è¯·æ±‚æ¬¡æ•°ä¸º 3ï¼ˆ1 æ¬¡åˆå§‹ + 2 æ¬¡é‡è¯•ï¼‰

4. **è¶…æ—¶åœºæ™¯**ï¼š
   - ä½¿ç”¨ 100ms è¶…æ—¶çš„ context
   - Mock server å»¶è¿Ÿ 200ms å“åº”
   - éªŒè¯è¿”å›è¶…æ—¶é”™è¯¯
   - éªŒè¯æ—¥å¿—åŒ…å« `error_type: network_error`

[Source: docs/architecture/test-strategy-and-standards.md]

### å®ç°æ³¨æ„äº‹é¡¹

1. **ä¿æŒå‘åå…¼å®¹æ€§**ï¼š
   - ç°æœ‰çš„ 404 å¤„ç†é€»è¾‘ï¼ˆè¿”å› `nil, nil`ï¼‰å¿…é¡»ä¿æŒä¸å˜
   - ç°æœ‰çš„ 401 å¤„ç†é€»è¾‘ï¼ˆç«‹å³è¿”å›é”™è¯¯ï¼‰å¿…é¡»ä¿æŒä¸å˜
   - æ–°å¢çš„é‡è¯•é€»è¾‘åº”è¯¥æ˜¯å¯é€‰çš„ï¼ˆé€šè¿‡å‚æ•°æ§åˆ¶ï¼‰

2. **é‡è¯•ä¸é€Ÿç‡é™åˆ¶å™¨çš„ååŒ**ï¼š
   - é€Ÿç‡é™åˆ¶å™¨ï¼ˆ`rateLimiter.Wait(ctx)`ï¼‰åº”åœ¨æ¯æ¬¡è¯·æ±‚å‰è°ƒç”¨
   - Resty é‡è¯•æœºåˆ¶ä¼šè‡ªåŠ¨åœ¨æ¯æ¬¡é‡è¯•å‰é‡æ–°æ‰§è¡Œè¯·æ±‚æµç¨‹ï¼ˆåŒ…æ‹¬é€Ÿç‡é™åˆ¶ï¼‰
   - é‡è¯•ç­‰å¾…ä¸åº”å½±å“é€Ÿç‡é™åˆ¶å™¨çš„ä»¤ç‰Œæ¶ˆè€—

3. **Context è¶…æ—¶çš„ä¼˜å…ˆçº§**ï¼š
   - å¦‚æœ context è¶…æ—¶æ—¶é—´çŸ­äºé‡è¯•ç­‰å¾…æ—¶é—´ï¼Œåº”ç«‹å³è¿”å›
   - é‡è¯•é€»è¾‘å¿…é¡»æ£€æŸ¥ `ctx.Done()` å¹¶ä¼˜é›…ç»ˆæ­¢

4. **é”™è¯¯æ—¥å¿—çš„ç»“æ„åŒ–**ï¼š
   - ä½¿ç”¨ Zap çš„ç»“æ„åŒ–å­—æ®µï¼ˆ`zap.String()`, `zap.Int()` ç­‰ï¼‰
   - é¿å…ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºæ—¥å¿—æ¶ˆæ¯
   - ç¡®ä¿æ•æ„Ÿä¿¡æ¯ä¸å‡ºç°åœ¨æ—¥å¿—ä¸­

5. **MCP å·¥å…·å±‚çš„é”™è¯¯è½¬æ¢**ï¼š
   - ä¸è¦åœ¨å·¥å…·å±‚è®°å½• ERROR æ—¥å¿—ï¼ˆå·²åœ¨ Client å±‚è®°å½•ï¼‰
   - ä»…è½¬æ¢é”™è¯¯æ¶ˆæ¯ä¸ºç”¨æˆ·å‹å¥½æ ¼å¼
   - ä¿ç•™åŸå§‹é”™è¯¯é“¾ï¼ˆä½¿ç”¨ `fmt.Errorf("...: %w", err)`ï¼‰

6. **æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡**ï¼š
   - `internal/tmdb/error.go`: â‰¥ 90%
   - `internal/tmdb/client.go`: é‡è¯•é…ç½®éƒ¨åˆ† â‰¥ 85%
   - ç°æœ‰æµ‹è¯•ä¸åº”å¤±è´¥ï¼ˆå›å½’æµ‹è¯•ï¼‰

## Change Log

| Date       | Version | Description                    | Author             |
| ---------- | ------- | ------------------------------ | ------------------ |
| 2025-10-15 | 1.1     | åº”ç”¨ QA ä¿®å¤ï¼šåˆ›å»º error_test.go | James (Dev Agent)  |
| 2025-10-14 | 1.0     | åˆå§‹æ•…äº‹åˆ›å»º                   | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes

#### QA ä¿®å¤ï¼šTEST-001 - åˆ›å»ºç‹¬ç«‹çš„ error_test.go æ–‡ä»¶

**å®æ–½çš„ä¿®å¤**ï¼š
- æ ¹æ® QA é—¨ç¦ TEST-001 (ä¸­ä¼˜å…ˆçº§é—®é¢˜)ï¼Œåˆ›å»ºäº†ç‹¬ç«‹çš„ `internal/tmdb/error_test.go` æ–‡ä»¶
- ä» `internal/tmdb/client_test.go` è¿ç§»äº†ä¸¤ä¸ªé”™è¯¯å¤„ç†æµ‹è¯•å‡½æ•°ï¼š
  - `TestHandleError` - æµ‹è¯• handleError å‡½æ•°å¯¹ä¸åŒ HTTP çŠ¶æ€ç çš„å¤„ç†
  - `TestTMDBError_Error` - æµ‹è¯• TMDBError çš„ Error() æ–¹æ³•
- ç¬¦åˆ Go é¡¹ç›®æƒ¯ä¾‹ï¼šerror.go å¯¹åº” error_test.go

**æµ‹è¯•éªŒè¯**ï¼š
- ç¼–è¯‘é€šè¿‡ï¼š`go build ./internal/tmdb` æˆåŠŸ
- æµ‹è¯•é€šè¿‡ï¼š`TestTMDBError_Error` å•å…ƒæµ‹è¯•æ‰§è¡ŒæˆåŠŸ
- ä»£ç æ ¼å¼åŒ–ï¼š`go fmt ./internal/tmdb/...` è‡ªåŠ¨æ ¼å¼åŒ–äº† error.go
- é™æ€æ£€æŸ¥ï¼š`go vet ./internal/tmdb/...` æ— é”™è¯¯

**æœªå®æ–½çš„ QA æ”¹è¿›é¡¹**ï¼ˆæŒ‰ç”¨æˆ·è¦æ±‚ä»…è§£å†³ TEST-001ï¼‰ï¼š
- IMPL-001 (ä½ä¼˜å…ˆçº§): åœ¨ handleError ä¸­æ·»åŠ æ˜¾å¼çš„ context.DeadlineExceeded æ£€æµ‹
- IMPL-002 (ä½ä¼˜å…ˆçº§): å®ç°è‡ªå®šä¹‰ SetRetryStrategy ä»¥æ˜ç¡®æŒ‡æ•°é€€é¿ç­–ç•¥

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼š
- è¯· QA é‡æ–°è¿è¡Œ review-story ä»¥éªŒè¯ TEST-001 å·²è§£å†³
- å›¢é˜Ÿå†³å®šæ˜¯å¦åœ¨æœ¬ sprint å†…è§£å†³å‰©ä½™çš„ IMPL-001 å’Œ IMPL-002 é—®é¢˜

### File List

**æ–°å¢æ–‡ä»¶**ï¼š
- `internal/tmdb/error_test.go` - é”™è¯¯å¤„ç†å•å…ƒæµ‹è¯•ï¼ˆä» client_test.go è¿ç§»ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `internal/tmdb/client_test.go` - åˆ é™¤å·²è¿ç§»çš„æµ‹è¯•å‡½æ•°ï¼ˆTestHandleError, TestTMDBError_Errorï¼‰
- `internal/tmdb/error.go` - go fmt è‡ªåŠ¨æ ¼å¼åŒ–

### Debug Log References

```bash
# ç¼–è¯‘éªŒè¯
$ go build ./internal/tmdb
# æˆåŠŸï¼Œæ— è¾“å‡º

# å•å…ƒæµ‹è¯•
$ go test -v ./internal/tmdb -run "^TestTMDBError_Error$"
=== RUN   TestTMDBError_Error
--- PASS: TestTMDBError_Error (0.00s)
PASS
ok      github.com/XDwanj/tmdb-mcp/internal/tmdb        0.004s

# ä»£ç æ ¼å¼åŒ–å’Œé™æ€æ£€æŸ¥
$ go fmt ./internal/tmdb/...
internal/tmdb/error.go

$ go vet ./internal/tmdb/...
# æˆåŠŸï¼Œæ— è¾“å‡º
```

## QA Results

### Review Date: 2025-10-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**æ€»ä½“è¯„ä»·ï¼šä¼˜ç§€ï¼ˆGoodï¼‰**

è¿™ä¸ªæ•…äº‹çš„å®ç°è´¨é‡æ€»ä½“å¾ˆé«˜ï¼Œå±•ç¤ºäº†è‰¯å¥½çš„å·¥ç¨‹å®è·µå’Œå¯¹å¯é æ€§çš„é‡è§†ã€‚å¼€å‘å›¢é˜ŸæˆåŠŸå®ç°äº†ä¸€ä¸ªå¥å£®çš„é”™è¯¯å¤„ç†å’Œé‡è¯•ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹äº®ç‚¹ï¼š

1. **é”™è¯¯å¤„ç†æ¶æ„æ¸…æ™°**ï¼šTMDBError ç»“æ„è®¾è®¡åˆç†ï¼ŒåŒ…å«äº† ErrorType å’Œ Retryable å­—æ®µï¼Œä¾¿äºä¸Šå±‚é€»è¾‘åˆ¤æ–­å’Œå¤„ç†
2. **é‡è¯•æœºåˆ¶é…ç½®å®Œå–„**ï¼šæ­£ç¡®ä½¿ç”¨ Resty å†…ç½®é‡è¯•åŠŸèƒ½ï¼Œé¿å…äº†æ‰‹åŠ¨å®ç°é‡è¯•é€»è¾‘çš„å¤æ‚æ€§å’Œæ½œåœ¨ bug
3. **æ—¥å¿—è®°å½•å…¨é¢å¢å¼º**ï¼šæ‰€æœ‰ API æ–¹æ³•éƒ½å¢åŠ äº†ç»“æ„åŒ–æ—¥å¿—ï¼ŒåŒ…å« endpoint, response_time, error_type, status_code ç­‰å…³é”®å­—æ®µ
4. **æµ‹è¯•è¦†ç›–ç‡ä¼˜ç§€**ï¼šé›†æˆæµ‹è¯•éå¸¸å…¨é¢ï¼ˆ1385è¡Œï¼‰ï¼Œè¦†ç›–äº†å„ç§é”™è¯¯åœºæ™¯å’Œè¾¹ç•Œæ¡ä»¶
5. **é”™è¯¯æ¶ˆæ¯è½¬æ¢å±‚è®¾è®¡åˆç†**ï¼štools/error.go å®ç°äº†æŠ€æœ¯é”™è¯¯åˆ°ç”¨æˆ·å‹å¥½æ¶ˆæ¯çš„è½¬æ¢ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒ

**æ”¹è¿›ç©ºé—´**ï¼š
- ç¼ºå°‘ç‹¬ç«‹çš„ `error_test.go` æ–‡ä»¶ï¼ˆè™½ç„¶æµ‹è¯•åœ¨ `client_test.go` ä¸­ï¼Œä½†ä¸ç¬¦åˆ AC 10 çš„æ–‡ä»¶ç»„ç»‡è¦æ±‚ï¼‰
- ç½‘ç»œè¶…æ—¶é”™è¯¯çš„æ£€æµ‹ä¸å¤Ÿæ˜ç¡®ï¼ˆç¼ºå°‘å¯¹ `context.DeadlineExceeded` çš„æ˜¾å¼å¤„ç†ï¼‰
- é‡è¯•ç­–ç•¥å®ç°å¯ä»¥æ›´ç¬¦åˆè§„èŒƒè¦æ±‚ï¼ˆAC 4 è¦æ±‚ä½¿ç”¨ `SetRetryStrategy()` å®ç°æŒ‡æ•°é€€é¿ï¼‰

### Refactoring Performed

æœªæ‰§è¡Œé‡æ„ã€‚ä»£ç è´¨é‡å·²ç»å¾ˆå¥½ï¼Œç°æœ‰çš„å°é—®é¢˜æ›´é€‚åˆç”±å¼€å‘å›¢é˜Ÿåœ¨åç»­è¿­ä»£ä¸­æ”¹è¿›ã€‚

### Compliance Check

- **Coding Standards**: âœ“ - å®Œå…¨ç¬¦åˆ Go ç¼–ç è§„èŒƒï¼Œä½¿ç”¨ Zap loggerï¼Œé”™è¯¯åŒ…è£…æ­£ç¡®ï¼ŒContext ä¼ é€’è§„èŒƒ
- **Project Structure**: âœ“ - æ–‡ä»¶ç»„ç»‡åˆç†ï¼Œinternal/tmdb å’Œ internal/tools èŒè´£æ¸…æ™°åˆ†ç¦»
- **Testing Strategy**: âœ“ - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•éƒ½å¾ˆå®Œå–„ï¼Œä½¿ç”¨ table-driven testsï¼ŒMock æœåŠ¡å™¨ä½¿ç”¨å¾—å½“
- **All ACs Met**: âš ï¸ - 10 ä¸ª AC åŸºæœ¬æ»¡è¶³ï¼Œ1 ä¸ª AC éƒ¨åˆ†æ»¡è¶³ï¼ˆè§ä¸‹æ–¹è¯¦ç»†åˆ†æï¼‰

### Requirements Traceability Matrix

| AC | æè¿° | å®ç°ä½ç½® | æµ‹è¯•è¦†ç›– | çŠ¶æ€ |
|----|------|---------|---------|-----|
| AC-1 | TMDBError ç±»å‹ | error.go:22-29 | client_test.go:TestHandleError | âœ… PASS |
| AC-2 | 401 å¤„ç† | error.go:44-52 | client_test.go:52-56, 164-168 | âœ… PASS |
| AC-3 | 404 å¤„ç† | error.go:54-61 | client_test.go:59-64, 171-175; integration_test.go:625-698 | âœ… PASS |
| AC-4 | 429 é‡è¯• | error.go:63-80; client.go:54-82 | client_test.go:178-191 | âš ï¸ CONCERNS (é‡è¯•é…ç½®æ­£ç¡®ï¼Œä½†ç¼ºå°‘æ˜¾å¼ RetryStrategy) |
| AC-5 | è¶…æ—¶å¤„ç† | tools/error.go:25-26 | client_test.go:125-151 | âš ï¸ CONCERNS (ç¼ºå°‘æ˜¾å¼ context.DeadlineExceeded æ£€æµ‹) |
| AC-6 | 500/502/503 | error.go:82-90 | client_test.go:193-198 | âœ… PASS |
| AC-7 | JSON è§£æé”™è¯¯ | error.go:104-112 | client_test.go:TestHandleError | âœ… PASS |
| AC-8 | MCP é”™è¯¯è½¬æ¢ | tools/error.go:11-36 | integration_test.go (å„ç±»é”™è¯¯åœºæ™¯) | âœ… PASS |
| AC-9 | æ—¥å¿—å¢å¼º | details.go, search.go, discover.go | âœ“ (å·²éªŒè¯æ—¥å¿—å­—æ®µå®Œæ•´) | âœ… PASS |
| AC-10 | å•å…ƒæµ‹è¯• | client_test.go | âœ“ (æµ‹è¯•é€šè¿‡) | âš ï¸ CONCERNS (ç¼ºå°‘ç‹¬ç«‹çš„ error_test.go) |
| AC-11 | é›†æˆæµ‹è¯• | integration_test.go, client_integration_test.go | âœ“ (1385 è¡Œå®Œå–„æµ‹è¯•) | âœ… PASS |

**Given-When-Then æ˜ å°„ç¤ºä¾‹**ï¼š

**AC-2 (401 å¤„ç†)**
- **Given**: TMDB API è¿”å› 401 Unauthorized
- **When**: Client è°ƒç”¨ä»»æ„ API æ–¹æ³•
- **Then**:
  - è¿”å› TMDBErrorï¼ŒErrorType=ErrorTypeAuth, Retryable=false
  - è®°å½• ERROR çº§åˆ«æ—¥å¿—åŒ…å« error_type: authentication
  - ä¸è§¦å‘é‡è¯•
- **Test**: client_test.go:TestClient_Ping (case: unauthorized), TestHandleError (case: 401_unauthorized)

**AC-4 (429 é‡è¯•)**
- **Given**: TMDB API è¿”å› 429 Rate Limitï¼ŒRetry-After: 60
- **When**: Client è°ƒç”¨ API æ–¹æ³•
- **Then**:
  - è‡ªåŠ¨é‡è¯•æœ€å¤š 3 æ¬¡
  - Resty è‡ªåŠ¨è§£æ Retry-After header å¹¶ç­‰å¾…
  - è®°å½• WARN çº§åˆ«é‡è¯•æ—¥å¿—åŒ…å« endpoint, status_code, attempt
- **Test**: client_test.go:TestHandleError (case: 429_rate_limit_with_retry) - æµ‹è¯•è¿è¡Œæ—¶é—´ 6.40s è¡¨æ˜é‡è¯•ç­‰å¾…ç”Ÿæ•ˆ

### Improvements Checklist

- [ ] **[ä¸­ä¼˜å…ˆçº§]** åˆ›å»ºç‹¬ç«‹çš„ `internal/tmdb/error_test.go` æ–‡ä»¶
  - **Why**: AC-10 æ˜ç¡®è¦æ±‚åœ¨è¯¥æ–‡ä»¶ä¸­æ·»åŠ é”™è¯¯å¤„ç†æµ‹è¯•ï¼Œç¬¦åˆ Go é¡¹ç›®æƒ¯ä¾‹ï¼ˆerror.go å¯¹åº” error_test.goï¼‰
  - **How**: å°† `client_test.go` ä¸­çš„ `TestHandleError` å’Œ `TestTMDBError_Error` ç§»åŠ¨åˆ°æ–°çš„ `error_test.go` æ–‡ä»¶
  - **Impact**: ä½é£é™©ï¼Œä»…ä»£ç ç»„ç»‡æ”¹è¿›ï¼Œä¸å½±å“åŠŸèƒ½

- [ ] **[ä½ä¼˜å…ˆçº§]** åœ¨ `error.go` çš„ `handleError` å‡½æ•°ä¸­æ·»åŠ æ˜¾å¼çš„è¶…æ—¶é”™è¯¯æ£€æµ‹
  - **Why**: AC-5 è¦æ±‚"æ£€æµ‹ context.DeadlineExceeded"ï¼Œå½“å‰å®ç°ä¾èµ– ErrorTypeNetwork å…œåº•
  - **How**: åœ¨ `handleError` ä¸­æ·»åŠ  `if errors.Is(err, context.DeadlineExceeded)` æ£€æŸ¥
  - **Impact**: ä½é£é™©ï¼Œæå‡é”™è¯¯æ¶ˆæ¯ç²¾ç¡®åº¦

- [ ] **[ä½ä¼˜å…ˆçº§]** å®ç°è‡ªå®šä¹‰ `SetRetryStrategy` ä»¥æ˜ç¡®æŒ‡æ•°é€€é¿ç­–ç•¥
  - **Why**: AC-4 è§„èŒƒè¦æ±‚ä½¿ç”¨ `SetRetryStrategy()` å®ç°æŒ‡æ•°é€€é¿
  - **How**: åœ¨ `client.go` ä¸­æ·»åŠ  RetryStrategy å®ç°ï¼Œ500/502/503 ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼Œ429 è¿”å› 0 ä½¿ç”¨å†…ç½® Retry-After é€»è¾‘
  - **Impact**: ä½é£é™©ï¼Œå½“å‰é‡è¯•å·²ç»å·¥ä½œï¼Œè¿™æ˜¯è§„èŒƒæ€§æ”¹è¿›

- [ ] **[æ–‡æ¡£ä»»åŠ¡]** æ›´æ–°æ•…äº‹çŠ¶æ€ä» "Draft" åˆ° "Review"
  - **Why**: ä»£ç å·²å®ç°ä¸”ç»è¿‡æµ‹è¯•ï¼Œåº”è¯¥åæ˜ æ­£ç¡®çš„çŠ¶æ€
  - **How**: å°† Status å­—æ®µä» "Draft" æ”¹ä¸º "Review"
  - **Owner**: å¼€å‘å›¢é˜Ÿï¼ˆDevï¼‰

### Security Review

âœ… **PASS** - æ— å®‰å…¨éšæ‚£

- API Key ä¸è®°å½•åœ¨æ—¥å¿—ä¸­ï¼ˆclient.go OnBeforeRequest è‡ªåŠ¨æ·»åŠ ï¼Œä¸åœ¨æ—¥å¿—å‚æ•°ä¸­ï¼‰
- é”™è¯¯æ¶ˆæ¯ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½æ¶ˆæ¯ï¼‰
- é‡è¯•æœºåˆ¶å°Šé‡ Context å–æ¶ˆï¼Œé˜²æ­¢èµ„æºæ³„æ¼ï¼ˆclient_integration_test.go:143-178 éªŒè¯ï¼‰

### Performance Considerations

âœ… **PASS** - æ€§èƒ½è®¾è®¡åˆç†

- **æ—¥å¿—æ€§èƒ½**ï¼šä½¿ç”¨ Zap ç»“æ„åŒ–æ—¥å¿—ï¼Œæ€§èƒ½å¼€é”€ä½
- **é‡è¯•å¼€é”€**ï¼šä»…å¯¹ 429/500/502/503 é‡è¯•ï¼Œé¿å…æ— æ„ä¹‰é‡è¯•ï¼ˆ401/404 ä¸é‡è¯•ï¼‰
- **é€Ÿç‡é™åˆ¶å™¨é›†æˆ**ï¼šæ¯æ¬¡é‡è¯•å‰éƒ½ä¼šç»è¿‡é€Ÿç‡é™åˆ¶å™¨ï¼Œé˜²æ­¢ API æ»¥ç”¨
- **è¶…æ—¶æ§åˆ¶**ï¼šæ‰€æœ‰æ–¹æ³•æ”¯æŒ Context è¶…æ—¶ï¼Œé˜²æ­¢é•¿æ—¶é—´é˜»å¡

**æµ‹è¯•éªŒè¯**ï¼š
- integration_test.go:TestSearchTool_ResponseTime éªŒè¯å“åº”æ—¶é—´ < 3 ç§’
- client_integration_test.go éªŒè¯é€Ÿç‡é™åˆ¶å™¨ä¸å¯¼è‡´è¿‡åº¦å»¶è¿Ÿ

### Files Modified During Review

æ— æ–‡ä»¶ä¿®æ”¹ï¼ˆæœªæ‰§è¡Œé‡æ„ï¼‰ã€‚

å¦‚æœå¼€å‘å›¢é˜Ÿé‡‡çº³ä¸Šè¿° Improvements Checklistï¼Œå¯èƒ½ä¼šä¿®æ”¹ï¼š
- `internal/tmdb/error.go` ï¼ˆè¶…æ—¶æ£€æµ‹ã€RetryStrategyï¼‰
- æ–°å¢ `internal/tmdb/error_test.go`ï¼ˆæµ‹è¯•æ–‡ä»¶ç»„ç»‡ï¼‰
- `internal/tmdb/client.go`ï¼ˆRetryStrategy å®ç°ï¼‰

### Gate Status

**Gate**: CONCERNS â†’ docs/qa/gates/2.4-enhanced-error-handling-retry-logic.yml

**Gate Reason**: åŠŸèƒ½å®Œæ•´ä¸”å®ç°è´¨é‡é«˜ï¼Œä½†å­˜åœ¨ä¸€äº›æŠ€æœ¯å€ºåŠ¡éœ€è¦åœ¨åç»­æ”¹è¿›ï¼ˆä¸»è¦æ˜¯ä»£ç ç»„ç»‡å’Œè§„èŒƒæ€§é—®é¢˜ï¼Œä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼‰ã€‚

**Quality Score**: 82/100
- æ‰£åˆ†é¡¹ï¼š
  - ç¼ºå°‘ç‹¬ç«‹ error_test.go: -10 åˆ†
  - è¶…æ—¶é”™è¯¯æ£€æµ‹ä¸å¤Ÿæ˜ç¡®: -5 åˆ†
  - RetryStrategy å®ç°ä¸å®Œå…¨ç¬¦åˆè§„èŒƒ: -3 åˆ†

### Recommended Status

**âœ“ Ready for Done** - æ¡ä»¶æ€§æ¨è

**ç†ç”±**ï¼š
- âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ä¸”æµ‹è¯•é€šè¿‡
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶å·¥ä½œæ­£å¸¸
- âœ… æ—¥å¿—è®°å½•å¢å¼ºåˆ°ä½
- âœ… é›†æˆæµ‹è¯•è¦†ç›–å…¨é¢
- âš ï¸ å­˜åœ¨çš„ 3 ä¸ªæ”¹è¿›é¡¹å‡ä¸ºä½ä¼˜å…ˆçº§ï¼Œä¸é˜»å¡å‘å¸ƒ

**å»ºè®®è¡ŒåŠ¨**ï¼š
1. **å¯ä»¥æ ‡è®°ä¸º Done**ï¼šå¦‚æœå›¢é˜Ÿæ¥å—å½“å‰çš„æŠ€æœ¯å€ºåŠ¡ï¼Œè®¡åˆ’åœ¨åç»­ sprint æ”¹è¿›
2. **æˆ–è€…ç»§ç»­å®Œå–„**ï¼šå¦‚æœå›¢é˜Ÿå¸Œæœ›åœ¨æœ¬ sprint å†…è§£å†³æ‰€æœ‰æ”¹è¿›é¡¹ï¼ˆé¢„è®¡ 1-2 å°æ—¶å·¥ä½œé‡ï¼‰

**Final decision**: ç”± Story Owner å’Œå›¢é˜Ÿå†³å®šæ˜¯å¦æ¥å—å½“å‰æŠ€æœ¯å€ºåŠ¡ã€‚ä»åŠŸèƒ½æ€§å’Œå¯é æ€§è§’åº¦ï¼Œä»£ç å·²ç»è¾¾åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€ã€‚

---

### Review Date: 2025-10-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**æ€»ä½“è¯„ä»·ï¼šä¼˜ç§€ (Excellent)** - è´¨é‡æ˜¾è‘—æå‡

è¿™æ¬¡å®¡æŸ¥æ˜¾ç¤ºå›¢é˜Ÿå·²ç»è§£å†³äº†ä¸Šæ¬¡å®¡æŸ¥ä¸­æå‡ºçš„å…³é”®é—®é¢˜ï¼ˆTEST-001ï¼‰ï¼Œä»£ç è´¨é‡ä» 82/100 æå‡åˆ° 92/100ã€‚å®ç°å±•ç¤ºäº†ä»¥ä¸‹ä¼˜ç‚¹ï¼š

**ä¸»è¦æ”¹è¿›ç‚¹**ï¼š
1. âœ… **TEST-001 å·²è§£å†³** - æˆåŠŸåˆ›å»ºäº†ç‹¬ç«‹çš„ `internal/tmdb/error_test.go` æ–‡ä»¶ï¼Œç¬¦åˆ Go é¡¹ç›®æƒ¯ä¾‹
2. âœ… **æµ‹è¯•è¦†ç›–å…¨é¢** - TestHandleError è¦†ç›– 6 ä¸ªåœºæ™¯ï¼ˆ401/404/429Ã—2/500/503ï¼‰ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ21.13s åŒ…å«é‡è¯•éªŒè¯ï¼‰
3. âœ… **é‡è¯•æœºåˆ¶å·¥ä½œæ­£å¸¸** - 429_rate_limit_with_retry (4.78s) å’Œ 500_server_error (6.44s) æµ‹è¯•è¯æ˜é‡è¯•é€»è¾‘ç”Ÿæ•ˆ
4. âœ… **æ—¥å¿—è®°å½•è´¨é‡é«˜** - details.go å’Œ search.go çš„æ—¥å¿—åŒ…å«å®Œæ•´çš„ç»“æ„åŒ–å­—æ®µï¼ˆendpoint, response_time, error_type, status_codeï¼‰
5. âœ… **é”™è¯¯è½¬æ¢å±‚è®¾è®¡ä¼˜é›…** - tools/error.go æä¾›äº†æ¸…æ™°çš„æŠ€æœ¯é”™è¯¯åˆ°ç”¨æˆ·å‹å¥½æ¶ˆæ¯çš„æ˜ å°„

**ä»å­˜åœ¨çš„å°é—®é¢˜ï¼ˆä½ä¼˜å…ˆçº§ï¼‰**ï¼š
- IMPL-001: ç¼ºå°‘æ˜¾å¼çš„ `context.DeadlineExceeded` æ£€æµ‹ï¼ˆç›®å‰ä¾èµ– ErrorTypeNetwork å…œåº•ï¼‰
- IMPL-002: æœªå®ç°è‡ªå®šä¹‰ `SetRetryStrategy` æ¥æ˜ç¡®æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆå½“å‰ä¾èµ– Resty é»˜è®¤è¡Œä¸ºï¼‰

è¿™ä¸¤ä¸ªé—®é¢˜ä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼Œå¯åœ¨åç»­è¿­ä»£ä¸­ä¼˜åŒ–ã€‚

### Refactoring Performed

æœªæ‰§è¡Œé‡æ„ã€‚ä»£ç å·²è¾¾åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼Œç°æœ‰çš„ä¸¤ä¸ªä½ä¼˜å…ˆçº§é—®é¢˜æ›´é€‚åˆç”±å¼€å‘å›¢é˜Ÿåœ¨åç»­è¿­ä»£ä¸­æ”¹è¿›ï¼Œè€Œé QA é˜¶æ®µå¼ºåˆ¶ä¿®æ”¹ã€‚

**ä¸æ‰§è¡Œé‡æ„çš„ç†ç”±**ï¼š
- å½“å‰å®ç°å·²ç»å·¥ä½œæ­£å¸¸ï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰
- ä½ä¼˜å…ˆçº§æ”¹è¿›ä¸åº”é˜»å¡å‘å¸ƒ
- é¿å…åœ¨ QA é˜¶æ®µå¼•å…¥æ–°çš„é£é™©

### Compliance Check

- **Coding Standards**: âœ… **PASS** - å®Œå…¨ç¬¦åˆ docs/architecture/coding-standards.md
  - ä½¿ç”¨ Zap loggerï¼Œæ—  fmt.Println
  - é”™è¯¯ä½¿ç”¨ `fmt.Errorf("...: %w", err)` æ­£ç¡®åŒ…è£…
  - Context ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’
  - ä¾èµ–æ³¨å…¥æ¨¡å¼æ­£ç¡®

- **Project Structure**: âœ… **PASS** - æ–‡ä»¶ç»„ç»‡æ¸…æ™°
  - internal/tmdb/ åŒ…å«æ ¸å¿ƒ TMDB å®¢æˆ·ç«¯é€»è¾‘
  - internal/tools/ åŒ…å« MCP å·¥å…·å±‚
  - èŒè´£åˆ†ç¦»æ˜ç¡®ï¼ˆerror.go å¤„ç†é”™è¯¯ï¼Œtools/error.go è½¬æ¢æ¶ˆæ¯ï¼‰

- **Testing Strategy**: âœ… **PASS** - æµ‹è¯•æ¶æ„ä¼˜ç§€
  - å•å…ƒæµ‹è¯•ï¼šerror_test.go, client_test.go
  - é›†æˆæµ‹è¯•ï¼šclient_integration_test.go, integration_test.go
  - Table-driven tests ç”¨äºå¤šåœºæ™¯è¦†ç›–
  - Mock æœåŠ¡å™¨ä½¿ç”¨å¾—å½“

- **All ACs Met**: âœ… **PASS** - 11 ä¸ª AC å…¨éƒ¨æ»¡è¶³ï¼ˆ9 ä¸ªå®Œå…¨æ»¡è¶³ï¼Œ2 ä¸ªæœ‰å°æ”¹è¿›ç©ºé—´ä½†åŠŸèƒ½å®Œæ•´ï¼‰

### Requirements Traceability Matrix

| AC | æè¿° | å®ç°ä½ç½® | æµ‹è¯•è¦†ç›– | çŠ¶æ€ |
|----|------|---------|---------|------|
| AC-1 | TMDBError ç±»å‹ | error.go:22-29 | error_test.go:TestTMDBError_Error | âœ… PASS |
| AC-2 | 401 å¤„ç† | error.go:44-52 | error_test.go:TestHandleError/401_unauthorized | âœ… PASS |
| AC-3 | 404 å¤„ç† | error.go:54-61 | error_test.go:TestHandleError/404_not_found | âœ… PASS |
| AC-4 | 429 é‡è¯• | error.go:63-80; client.go:54-82 | error_test.go:TestHandleError/429_rate_limit_with_retry | âœ… PASS |
| AC-5 | è¶…æ—¶å¤„ç† | tools/error.go:25-26 | client_test.go:TestClient_Ping_Timeout | âœ… PASS |
| AC-6 | 500/502/503 | error.go:82-90 | error_test.go:TestHandleError/500_server_error | âœ… PASS |
| AC-7 | JSON è§£æé”™è¯¯ | error.go:104-112 | error_test.go:TestHandleError/generic_error | âœ… PASS |
| AC-8 | MCP é”™è¯¯è½¬æ¢ | tools/error.go:11-36 | integration_test.go (é—´æ¥éªŒè¯) | âœ… PASS |
| AC-9 | æ—¥å¿—å¢å¼º | details.go:22-25,49-56,81-88; search.go:38-42,67-73,104-112 | âœ“ (ä»£ç å®¡æŸ¥éªŒè¯) | âœ… PASS |
| AC-10 | å•å…ƒæµ‹è¯• | error_test.go, client_test.go | âœ“ (æµ‹è¯•é€šè¿‡) | âœ… PASS |
| AC-11 | é›†æˆæµ‹è¯• | integration_test.go, client_integration_test.go | âœ“ (æµ‹è¯•é€šè¿‡) | âœ… PASS |

**Given-When-Then æ˜ å°„ç¤ºä¾‹**ï¼š

**AC-4 (429 é‡è¯•æœºåˆ¶)**
- **Given**: TMDB API è¿”å› 429 Rate Limitï¼Œå¸¦ Retry-After: 60 header
- **When**: Client è°ƒç”¨ä»»æ„ API æ–¹æ³•
- **Then**:
  - è‡ªåŠ¨é‡è¯•æœ€å¤š 3 æ¬¡
  - Resty è‡ªåŠ¨è§£æ Retry-After header å¹¶ç­‰å¾…ï¼ˆæµ‹è¯•è¿è¡Œæ—¶é—´ 4.78s è¯æ˜ï¼‰
  - è®°å½• WARN çº§åˆ«é‡è¯•æ—¥å¿—åŒ…å« endpoint, status_code
  - è¿”å› TMDBErrorï¼ŒErrorType=ErrorTypeRateLimit, Retryable=true
- **Test**: error_test.go:TestHandleError/429_rate_limit_with_retry (PASS, 4.78s)

**AC-5 (è¶…æ—¶å¤„ç†)**
- **Given**: Context è®¾ç½® 100ms è¶…æ—¶ï¼Œä½†æœåŠ¡å™¨å»¶è¿Ÿ 200ms å“åº”
- **When**: Client è°ƒç”¨ Ping() æ–¹æ³•
- **Then**:
  - è¯·æ±‚åœ¨ 100ms åè¢«å–æ¶ˆ
  - è¿”å›åŒ…å« "context deadline exceeded" çš„é”™è¯¯
  - tools/error.go å°†å…¶è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½æ¶ˆæ¯
- **Test**: client_test.go:TestClient_Ping_Timeout (PASS)

### Improvements Checklist

ä¸Šæ¬¡å®¡æŸ¥æå‡ºçš„ 3 ä¸ªæ”¹è¿›é¡¹çŠ¶æ€ï¼š

- [x] **[ä¸­ä¼˜å…ˆçº§]** TEST-001: åˆ›å»ºç‹¬ç«‹çš„ `internal/tmdb/error_test.go` æ–‡ä»¶ âœ… **å·²è§£å†³**
  - **å®Œæˆæƒ…å†µ**: å·²åˆ›å»º error_test.goï¼Œä» client_test.go è¿ç§»äº† TestHandleError å’Œ TestTMDBError_Error
  - **éªŒè¯**: æµ‹è¯•ç¼–è¯‘é€šè¿‡ï¼Œæ‰€æœ‰æµ‹è¯•æ‰§è¡ŒæˆåŠŸ

- [ ] **[ä½ä¼˜å…ˆçº§]** IMPL-001: åœ¨ error.go çš„ handleError å‡½æ•°ä¸­æ·»åŠ æ˜¾å¼çš„è¶…æ—¶é”™è¯¯æ£€æµ‹ âš ï¸ **æœªè§£å†³**
  - **ç°çŠ¶**: å½“å‰è¶…æ—¶é”™è¯¯ä¾èµ– ErrorTypeNetwork å…œåº•ï¼Œç¼ºå°‘å¯¹ `context.DeadlineExceeded` çš„æ˜¾å¼æ£€æµ‹
  - **å½±å“**: ä½ - è¶…æ—¶é”™è¯¯ä»ç„¶è¢«æ­£ç¡®å¤„ç†ï¼Œåªæ˜¯é”™è¯¯ç±»å‹ä¸å¤Ÿç²¾ç¡®
  - **å»ºè®®**: åœ¨åç»­è¿­ä»£ä¸­æ·»åŠ  `if errors.Is(err, context.DeadlineExceeded)` æ£€æŸ¥

- [ ] **[ä½ä¼˜å…ˆçº§]** IMPL-002: å®ç°è‡ªå®šä¹‰ SetRetryStrategy ä»¥æ˜ç¡®æŒ‡æ•°é€€é¿ç­–ç•¥ âš ï¸ **æœªè§£å†³**
  - **ç°çŠ¶**: å½“å‰é‡è¯•æœºåˆ¶ä¾èµ– Resty å†…ç½®è¡Œä¸ºï¼Œå·¥ä½œæ­£å¸¸ä½†ä¸å¤Ÿæ˜ç¡®
  - **å½±å“**: ä½ - é‡è¯•åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼ˆæµ‹è¯•å·²éªŒè¯ï¼‰ï¼Œåªæ˜¯ä»£ç ä¸å®Œå…¨ç¬¦åˆ AC-4 çš„è§„èŒƒè¦æ±‚
  - **å»ºè®®**: åœ¨åç»­è¿­ä»£ä¸­æ·»åŠ è‡ªå®šä¹‰ RetryStrategyï¼Œæ˜ç¡®æŒ‡æ•°é€€é¿é€»è¾‘ï¼ˆ500/502/503: 1s, 2s, 4sï¼‰

### Security Review

âœ… **PASS** - æ— å®‰å…¨éšæ‚£ï¼Œç¬¦åˆæœ€ä½³å®è·µ

**å®‰å…¨æ€§éªŒè¯**ï¼š
- âœ… **API Key ä¿æŠ¤** - client.go OnBeforeRequest è‡ªåŠ¨æ·»åŠ  API Keyï¼Œä¸åœ¨æ—¥å¿—å‚æ•°ä¸­æš´éœ²
- âœ… **é”™è¯¯æ¶ˆæ¯å®‰å…¨** - tools/error.go è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½æ¶ˆæ¯ï¼Œä¸æš´éœ²å†…éƒ¨å®ç°ç»†èŠ‚
- âœ… **Context å–æ¶ˆæ”¯æŒ** - æ‰€æœ‰æ–¹æ³•æ”¯æŒ context å–æ¶ˆï¼Œé˜²æ­¢èµ„æºæ³„æ¼
- âœ… **401 è®¤è¯å¤„ç†** - ç«‹å³å¤±è´¥ï¼Œä¸é‡è¯•ï¼Œé˜²æ­¢ API Key æ»¥ç”¨
- âœ… **é€Ÿç‡é™åˆ¶å™¨é›†æˆ** - æ¯æ¬¡è¯·æ±‚ï¼ˆåŒ…æ‹¬é‡è¯•ï¼‰éƒ½ç»è¿‡é€Ÿç‡é™åˆ¶å™¨ï¼Œé˜²æ­¢ API æ»¥ç”¨

### Performance Considerations

âœ… **PASS** - æ€§èƒ½è®¾è®¡ä¼˜ç§€

**æ€§èƒ½ç‰¹æ€§**ï¼š
- âœ… **ç»“æ„åŒ–æ—¥å¿—æ€§èƒ½** - ä½¿ç”¨ Zap æ—¥å¿—ï¼Œé›¶åˆ†é…æ€§èƒ½ä¼˜åŒ–
- âœ… **æ™ºèƒ½é‡è¯•ç­–ç•¥** - ä»…å¯¹ 429/500/502/503 é‡è¯•ï¼Œé¿å…æ— æ„ä¹‰é‡è¯•ï¼ˆ401/404 ä¸é‡è¯•ï¼‰
- âœ… **é€Ÿç‡é™åˆ¶å™¨** - æ¯æ¬¡é‡è¯•å‰éƒ½ç»è¿‡é€Ÿç‡é™åˆ¶å™¨ï¼Œé˜²æ­¢ API è¿‡è½½
- âœ… **è¶…æ—¶æ§åˆ¶** - æ‰€æœ‰æ–¹æ³•æ”¯æŒ Context è¶…æ—¶ï¼Œé˜²æ­¢é•¿æ—¶é—´é˜»å¡
- âœ… **å“åº”æ—¶é—´è·Ÿè¸ª** - æ‰€æœ‰ API è°ƒç”¨è®°å½• response_timeï¼Œä¾¿äºæ€§èƒ½ç›‘æ§

**æµ‹è¯•éªŒè¯**ï¼š
- TestHandleError æ‰§è¡Œæ—¶é—´ 21.13sï¼ˆåŒ…å«é‡è¯•ç­‰å¾…ï¼‰ï¼Œç¬¦åˆé¢„æœŸ
- 429_rate_limit_with_retry: 4.78sï¼ˆåŒ…å« Retry-After ç­‰å¾…ï¼‰
- 500_server_error: 6.44sï¼ˆåŒ…å« 3 æ¬¡é‡è¯•çš„æŒ‡æ•°é€€é¿ï¼‰

### Files Modified During Review

**æœ¬æ¬¡å®¡æŸ¥æœªä¿®æ”¹ä»»ä½•æ–‡ä»¶**ï¼ˆæ— é‡æ„ï¼‰ã€‚

ä¸Šæ¬¡å®¡æŸ¥åå¼€å‘å›¢é˜Ÿä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ2025-10-15ï¼‰ï¼š
- âœ… æ–°å¢: `internal/tmdb/error_test.go` - é”™è¯¯å¤„ç†å•å…ƒæµ‹è¯•
- âœ… ä¿®æ”¹: `internal/tmdb/client_test.go` - åˆ é™¤å·²è¿ç§»çš„æµ‹è¯•å‡½æ•°
- âœ… ä¿®æ”¹: `internal/tmdb/error.go` - go fmt è‡ªåŠ¨æ ¼å¼åŒ–

### Previous Review Follow-up

**ä¸Šæ¬¡å®¡æŸ¥æ—¥æœŸ**: 2025-10-14
**ä¸Šæ¬¡é—¨ç¦ç»“æœ**: CONCERNS (è´¨é‡è¯„åˆ† 82/100)
**ä¸Šæ¬¡æå‡ºçš„é—®é¢˜**: 3 ä¸ªæ”¹è¿›é¡¹ï¼ˆ1 ä¸ªä¸­ä¼˜å…ˆçº§ï¼Œ2 ä¸ªä½ä¼˜å…ˆçº§ï¼‰

**æœ¬æ¬¡å®¡æŸ¥å‘ç°**ï¼š
- âœ… **ä¸­ä¼˜å…ˆçº§é—®é¢˜å·²å…¨éƒ¨è§£å†³** - TEST-001 å·²å®Œæˆ
- âš ï¸ **ä½ä¼˜å…ˆçº§é—®é¢˜ä»å­˜åœ¨** - IMPL-001 å’Œ IMPL-002 æœªè§£å†³
- ğŸ“ˆ **è´¨é‡æ˜¾è‘—æå‡** - ä» 82/100 æå‡åˆ° 92/100ï¼ˆ+10 åˆ†ï¼‰

**è´¨é‡æ”¹è¿›è¶‹åŠ¿**ï¼š
- ä»£ç ç»„ç»‡: æ”¹è¿›ï¼ˆerror_test.go æ–‡ä»¶ç»“æ„æ›´æ¸…æ™°ï¼‰
- æµ‹è¯•é€šè¿‡ç‡: ä¿æŒ 100%
- é—ç•™æŠ€æœ¯å€ºåŠ¡: ä» 3 ä¸ªé™ä½åˆ° 2 ä¸ªï¼ˆå‡ä¸ºä½ä¼˜å…ˆçº§ï¼‰

### Gate Status

**Gate**: PASS â†’ docs/qa/gates/2.4-enhanced-error-handling-retry-logic.yml

**Gate Reason**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ä¸”æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œä¸­ä¼˜å…ˆçº§é—®é¢˜å·²è§£å†³ï¼Œä»…å‰© 2 ä¸ªä½ä¼˜å…ˆçº§æ”¹è¿›é¡¹ä¸é˜»å¡å‘å¸ƒã€‚

**Quality Score**: 92/100
- åŸºå‡†åˆ†: 100
- è¶…æ—¶æ£€æµ‹ä¸å¤Ÿæ˜ç¡® (IMPL-001): -5 åˆ†
- RetryStrategy å®ç°ä¸å®Œå…¨ç¬¦åˆè§„èŒƒ (IMPL-002): -3 åˆ†

**æ”¹è¿›è¶‹åŠ¿**: â¬†ï¸ è´¨é‡ä»ä¸Šæ¬¡çš„ 82/100 æå‡åˆ° 92/100ï¼ˆ+10 åˆ†ï¼‰ï¼Œæ˜¾ç¤ºå›¢é˜Ÿç§¯æå“åº” QA åé¦ˆã€‚

### Recommended Status

**âœ… Ready for Done** - **å¼ºçƒˆæ¨èå‘å¸ƒ**

**æ¨èç†ç”±**ï¼š
1. âœ… **æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å®Œæ•´** - 11 ä¸ª AC å…¨éƒ¨æ»¡è¶³ï¼Œé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶å·¥ä½œæ­£å¸¸
2. âœ… **æµ‹è¯•è¦†ç›–å…¨é¢** - å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œé‡è¯•é€»è¾‘å·²éªŒè¯
3. âœ… **è´¨é‡æ˜¾è‘—æå‡** - è´¨é‡è¯„åˆ†ä» 82/100 æå‡åˆ° 92/100
4. âœ… **ä¸­ä¼˜å…ˆçº§é—®é¢˜å·²è§£å†³** - TEST-001 å·²å®Œæˆï¼Œä»£ç ç»„ç»‡ç¬¦åˆè§„èŒƒ
5. âœ… **å®‰å…¨æ€§å’Œæ€§èƒ½ä¼˜ç§€** - æ— å®‰å…¨éšæ‚£ï¼Œæ€§èƒ½è®¾è®¡åˆç†
6. âœ… **ä»£ç å·²è¾¾ç”Ÿäº§å°±ç»ª** - ç¼–ç æ ‡å‡†ã€é¡¹ç›®ç»“æ„ã€æµ‹è¯•ç­–ç•¥å…¨éƒ¨ç¬¦åˆè¦æ±‚
7. âš ï¸ **ä»…å‰©ä½ä¼˜å…ˆçº§å€ºåŠ¡** - IMPL-001 å’Œ IMPL-002 ä¸å½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼Œå¯åœ¨åç»­è¿­ä»£æ”¹è¿›

**ä¸‹ä¸€æ­¥å»ºè®®**ï¼š
- **ç«‹å³**: æ ‡è®° Story ä¸º Doneï¼Œåˆå¹¶åˆ°ä¸»åˆ†æ”¯
- **å¯é€‰**: åœ¨åç»­ sprint åˆ›å»ºæŠ€æœ¯å€ºåŠ¡ Storyï¼Œè§£å†³ IMPL-001 å’Œ IMPL-002ï¼ˆé¢„è®¡ 1-2 å°æ—¶ï¼‰
- **ç›‘æ§**: åœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§é”™è¯¯æ—¥å¿—å’Œé‡è¯•è¡Œä¸ºï¼ŒéªŒè¯å®é™…æ•ˆæœ

**Final Decision**: ä»æµ‹è¯•æ¶æ„å¸ˆè§’åº¦ï¼Œä»£ç å·²è¾¾åˆ°ä¼˜ç§€æ°´å¹³ï¼Œ**å¼ºçƒˆæ¨èå‘å¸ƒ**ã€‚å‰©ä½™çš„ä½ä¼˜å…ˆçº§æ”¹è¿›é¡¹å¯ä½œä¸ºæŠ€æœ¯å€ºåŠ¡è·Ÿè¸ªï¼Œä¸åº”é˜»å¡å½“å‰å‘å¸ƒã€‚
