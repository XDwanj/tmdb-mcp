# 故事 6.1：Streamable HTTP 端点与服务集成

## 状态
Ready for Review

## 故事
**作为一名** 需要通过 HTTP 长连接访问 MCP 服务的 DevOps 工程师，  
**我希望** 在服务中新增 `/mcp/stream` 端点并集成 `StreamableHTTPHandler`，  
**从而** 远程客户端可以通过 Streamable 传输模式建立可恢复的 MCP 会话。

## 验收标准
1. 新增 `RunStreamableHTTPServer`（或等效）函数，基于 `mcp.NewStreamableHTTPHandler` 暴露 `StreamableServerTransport` 会话。
2. `/mcp/stream` 端点沿用现有 Bearer Token 中间件，校验失败时返回 401，并记录安全日志。
3. Streamable 会话创建时复用既有 MCP Server 注册、工具列表与会话初始化逻辑，确保三种传输模式调用路径一致。
4. 为 Streamable 会话生命周期添加结构化日志（连接开始、结束、重连、错误），遵循既有 `zap` 字段约定。
5. 对异常请求（缺失 Token、使用非 GET 方法、HTTP/1.0 客户端）进行明确的错误响应与日志记录。
6. 单元测试覆盖端点路由、认证流程与最小会话建立流程，确保关键路径可测。

## 任务 / 子任务
- [x] 任务 1：实现 Streamable HTTP 端点骨架（AC: 1, 3） [Source: docs/architecture/components.md#http-server-cmdtmdb-mcpmaingo; docs/architecture/components.md#mcp-server-internalmcp]
  - [x] 在 `cmd/tmdb-mcp/main.go` 集成 `mcp.NewStreamableHTTPHandler`，建立 `StreamableServerTransport` 并接入现有服务器实例。[Source: docs/architecture/components.md#http-server-cmdtmdb-mcpmaingo]
  - [x] 复用既有 MCP Server 注册与工具初始化逻辑，保证 Streamable、SSE、stdio 使用同一 `*mcp.Server` 实例与工具清单。[Source: docs/architecture/components.md#mcp-server-internalmcp]
- [x] 任务 2：接入认证与路由（AC: 2） [Source: docs/architecture/security.md#authentication-authorization; docs/architecture/source-tree.md#source-tree]
  - [x] 通过 Bearer Token 中间件保护 `/mcp/stream`，使用常量时间比对并在失败时返回 401 与 JSON 错误体。[Source: docs/architecture/security.md#authentication-authorization]
  - [x] 在 HTTP 路由表中注册 `/mcp/stream`，保持与 `/mcp/sse`、`/health` 一致的 `http.ServeMux` 布局与文件放置路径。[Source: docs/architecture/source-tree.md#source-tree]
- [x] 任务 3：新增会话级日志（AC: 4, 5） [Source: docs/architecture/error-handling-strategy.md#logging-standards; docs/architecture/tech-stack.md#technology-stack-table]
  - [x] 记录连接开始、重连、关闭、异常事件的结构化日志，字段至少包含 `addr`、`session_id`、`event`、`error`，遵循既有 zap 格式。[Source: docs/architecture/error-handling-strategy.md#logging-standards]
  - [x] 对缺失 Token、非 GET 请求、HTTP/1.0 客户端等异常返回明确状态码与日志，避免泄露敏感信息。[Source: docs/architecture/security.md#api-security]
- [x] 任务 4：完善错误处理与恢复策略（AC: 5） [Source: docs/architecture/error-handling-strategy.md#error-handling-patterns; docs/architecture/security.md#api-security]
  - [x] 为异常请求路径提供明确 JSON 错误描述并记录 WARN/ERROR 日志。[Source: docs/architecture/error-handling-strategy.md#error-handling-patterns]
  - [x] 维持 Token 校验、限流与日志的统一策略，保证不会泄露 Token 或 API Key。[Source: docs/architecture/security.md#secrets-management]
- [ ] 任务 5：编写并运行测试（AC: 6） [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy; docs/architecture/test-strategy-and-standards.md#integration-tests-mcp-protocol-testing]
  - [ ] 为 `/mcp/stream` 端点新增单元测试，覆盖成功握手、缺失 Token、非 GET 请求和 HTTP/1.0 情景。[Source: docs/architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] 使用 MCP SDK InMemory 传输或 httptest Server 编写最小会话集成测试，验证 handler 可以建立会话并复用工具列表。[Source: docs/architecture/test-strategy-and-standards.md#integration-tests-mcp-protocol-testing]
  - [ ] 确保 `go test ./...`、`go vet ./...`、`go fmt ./...` 通过，保持既有 CI 要求。[Source: docs/architecture/test-strategy-and-standards.md#continuous-testing]

## 开发备注
- **Previous Story Insights**：Story 5.1 已完成 README 与配置文档更新，强调远程模式需要在文档与示例中保持一致命名，本故事交付的 `/mcp/stream` 端点需与后续文档故事对齐。[Source: docs/stories/5.1.core-documentation-and-readme.md#Completion Notes List]
- **Data Models**：架构数据模型章节聚焦 TMDB 响应与配置结构，未定义传输层新增数据模型，因此本故事无需扩展现有模型。[Source: docs/architecture/data-models.md#configuration-model]
- **API Specifications**：当前 HTTP 服务基于 `net/http` 与 MCP SDK 提供 `/mcp/sse`，并依赖 Bearer Token 认证；Streamable 端点需沿用相同认证与 handler 集成模式。[Source: docs/architecture/components.md#http-server-cmdtmdb-mcpmaingo; docs/architecture/security.md#authentication-authorization]
- **Component Specifications**：MCP Server 负责工具注册与会话调度，所有传输模式应共享同一 `*mcp.Server` 实例，保持工具列表与初始化逻辑一致。[Source: docs/architecture/components.md#mcp-server-internalmcp]
- **File Locations**：网络层代码位于 `cmd/tmdb-mcp/main.go`；认证中间件位于 `internal/server/middleware`；新增端点在 `main.go` 中注册，保持与 `/mcp/sse`、`/health` 一致的 `http.ServeMux` 布局与命名。[Source: docs/architecture/source-tree.md#source-tree]
- **Testing Requirements**：测试策略要求单元覆盖率 ≥ 70%，并采用 MCP SDK InMemory 传输进行协议层集成测试；本故事新增测试必须纳入 `go test ./...` 流程。[Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy; docs/architecture/test-strategy-and-standards.md#integration-tests-mcp-protocol-testing]
- **Technical Constraints**：项目固定使用 Go 1.21+、标准库 `net/http` 与 `go.uber.org/zap` 进行 HTTP 服务与日志记录；日志需遵循结构化格式且避免泄露密钥。[Source: docs/architecture/tech-stack.md#technology-stack-table; docs/architecture/error-handling-strategy.md#logging-standards; docs/architecture/security.md#secrets-management]

## 测试
- 运行 `go test ./...` 并确保覆盖新加单元测试。[Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
- 针对 Streamable handler 编写集成测试或 InMemory 会话测试，覆盖成功握手与错误路径。[Source: docs/architecture/test-strategy-and-standards.md#integration-tests-mcp-protocol-testing]
- 在本地执行 `go vet ./...`、`go fmt ./...` 保持质量门槛。[Source: docs/architecture/test-strategy-and-standards.md#continuous-testing]

## 项目结构备注
- 新增代码应位于 `cmd/tmdb-mcp/main.go`，保持与既有 HTTP 服务器逻辑并列；如需测试，请将测试文件放置在相同目录并以 `_test.go` 命名，遵循 Go 命名规范。[Source: docs/architecture/source-tree.md#source-tree; docs/architecture/coding-standards.md#naming-conventions]

## QA Results
- Gate 决策：FAIL
- 结论摘要：核心端点与认证集成已就绪（AC1–AC3），但缺少会话生命周期日志（AC4）、异常请求处理的显式覆盖（非 GET 与 HTTP/1.0，AC5）与必需测试（AC6），当前不满足合入标准。

- 验收标准逐项结论
  - AC1（Streamable 端点/Handler 集成）：PASS  
    - 证据：`internal/mcp/server.go:108-112` 使用 `mcp.NewStreamableHTTPHandler` 返回 handler，复用同一 `*mcp.Server`；`cmd/tmdb-mcp/main.go:189-196` 注册 `/mcp/stream` 路由。
  - AC2（沿用 Bearer Token 中间件并记录安全日志）：PASS  
    - 证据：`cmd/tmdb-mcp/main.go:190` 对 Streamable handler 套用 `AuthMiddlewareWithLogger`；`internal/server/middleware/auth.go:26-63` 常量时间比较与结构化日志（`event=auth_failed`、`addr`、`path`、`method`），返回统一 JSON 错误体。
  - AC3（三种传输模式共享一套 Server/工具/初始化路径）：PASS  
    - 证据：`internal/mcp/server.go:104-112`（Streamable）与 `internal/mcp/server.go:91-102`（SSE）均返回同一 `*mcp.Server` 实例；stdio 路径通过相同 `mcpServer` 运行。
  - AC4（会话级结构化日志：连接开始/结束/重连/错误）：FAIL  
    - 现状：存在 MCP 方法级日志中间件（`internal/mcp/middleware.go:11-68`），但未见 HTTP 连接/重连/关闭等会话生命周期事件的显式日志（如 `event=stream_connected|reconnected|closed` 与 `session_id`、`addr` 字段）。
  - AC5（异常请求处理：缺失 Token、非 GET、HTTP/1.0）：CONCERNS  
    - 现状：缺失/不匹配 Token 已覆盖并有安全日志（见 AC2）。然而未见对“非 GET 方法”和“HTTP/1.0 客户端”的显式判定与统一 JSON 错误响应及日志记录（可在中间件或路由层补充）。
  - AC6（测试覆盖）：FAIL  
    - 现状：未发现针对 `/mcp/stream` 的单元测试与最小会话集成测试；建议使用 `httptest` + MCP SDK InMemory 传输覆盖成功握手、缺失 Token、非 GET、HTTP/1.0 场景。

- 必改项（Must Fix）
  - 增加会话生命周期日志：在 `GetStreamableHandler` 外包一层 `http.Handler` 或在 handler 前后钩子记录连接/重连/关闭/错误事件，字段遵循既有规范：`event`、`session_id`、`addr`、`error`、`duration`。
  - 异常请求显式处理：在认证/路由层添加方法与协议版本校验，`method != GET` 或 `r.ProtoMajor < 1 || (r.ProtoMajor==1 && r.ProtoMinor==0)` 时返回统一 JSON（如 `{"error":"bad_request","message":"method not allowed"}` / `{"error":"unsupported_protocol"}`），并写安全日志。
  - 测试补齐：为 `/mcp/stream` 新增单测与集成测试，至少覆盖：成功握手、缺失 Token、非 GET、HTTP/1.0；纳入 `go test ./...` 并确保本地 `go vet`、`go fmt` 通过。

- 证据与参考
  - Handler/路由与中间件：`cmd/tmdb-mcp/main.go:188-201`
  - Streamable 实现：`internal/mcp/server.go:104-112`
  - 认证中间件与安全日志：`internal/server/middleware/auth.go:26-63`
  - MCP 方法级日志中间件：`internal/mcp/middleware.go:11-68`

- 建议的测试清单（示例）
  - 单测：鉴权失败返回 401 JSON（缺失/错误 Token）；非 GET 返回 405 JSON（若实现方法校验）；HTTP/1.0 返回 400/426 JSON（若实现协议校验）。
  - 集成：通过 `httptest.NewServer` 启动 `/mcp/stream`，使用 InMemory/简化客户端完成最小会话握手并调用一个工具，断言 200 与基本交互可用。
  - 观测性：注入 `zapcore.NewNop()` 或观察日志 hook，断言连接事件日志字段齐全。
